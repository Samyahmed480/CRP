<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة العملاء - CRP </title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <!-- Google Fonts (Cairo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8f9fc; /* Light background typical of modern dashboards */
        }
        
        .dark body {
            background-color: #0f172a;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        
        /* Input Styles matching the reference images */
        .form-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.6rem 1rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            outline: none;
            background-color: #ffffff;
        }
        .form-input:focus {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Dark Mode for Inputs */
        .dark .form-input {
            background-color: #1e293b;
            border-color: #334155;
            color: #f1f5f9;
        }
        .dark .form-input:focus {
            border-color: #60a5fa;
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #4b5563; /* gray-600 */
            margin-bottom: 0.25rem;
        }
        .dark .form-label {
            color: #94a3b8;
        }

        /* Upload Zone Style */
        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            background-color: #f8fafc;
            transition: all 0.2s;
        }
        .upload-zone:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .dark .upload-zone {
            background-color: #1e293b;
            border-color: #334155;
        }
        .dark .upload-zone:hover {
            background-color: #334155;
            border-color: #60a5fa;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-scaleIn {
            animation: scaleIn 0.2s ease-out forwards;
        }
        
        .active-nav-item {
            background-color: #1a4b82;
            color: white;
            border-right: 4px solid #e5b57f;
        }
        .inactive-nav-item {
            color: #dbeafe; /* blue-100 */
            border-right: 4px solid transparent;
        }
        .inactive-nav-item:hover {
            background-color: #0a2342;
            color: white;
        }

        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden dark:text-slate-100">

    <!-- Sidebar -->
    <aside id="sidebar" class="bg-[#0f3057] text-white w-64 flex-shrink-0 flex flex-col transition-all duration-300 shadow-2xl z-20 h-full md:relative absolute transform -translate-x-full md:translate-x-0">
        <div class="p-6 flex flex-col items-center border-b border-blue-900/50">
            <!-- Logo -->
            <div id="company-logo-container" class="w-20 h-20 mb-3 bg-[#fdf6e7] rounded-2xl flex items-center justify-center shadow-lg relative overflow-hidden transform rotate-3 hover:rotate-0 transition-transform duration-300">
                <svg viewBox="0 0 100 100" class="w-full h-full p-1">
                    <path d="M 10,50 A 40,40 0 1,1 90,50" fill="none" stroke="#0f3057" stroke-width="8" stroke-linecap="round" />
                    <path d="M 90,50 A 40,40 0 1,1 10,50" fill="none" stroke="#f97316" stroke-width="8" stroke-linecap="round" />
                    <text x="50" y="72" font-family="Arial, sans-serif" font-weight="800" font-size="60" text-anchor="middle" fill="#0f3057">1</text>
                </svg>
            </div>
            <h1 id="company-name-display" class="text-lg font-bold tracking-wider text-center font-sans">IN ONE OPERATION</h1>
            <p id="company-subtitle-display" class="text-[10px] text-blue-200 mt-1 uppercase tracking-widest opacity-80">System Management</p>
        </div>

        <nav class="flex-1 px-3 space-y-1.5 mt-6 overflow-y-auto custom-scrollbar">
            <!-- Navigation Items -->
            <button onclick="switchTab('registration')" id="nav-registration" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 active-nav-item group">
                <i data-lucide="user-check" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">تسجيل العملاء</span>
            </button>
            <button onclick="switchTab('measurements')" id="nav-measurements" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="ruler" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">أخذ المقاسات</span>
            </button>
            <button onclick="switchTab('design')" id="nav-design" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="pen-tool" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">التصميم</span>
            </button>
            <button onclick="switchTab('pricing')" id="nav-pricing" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="calculator" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">التسعير التفصيلي</span>
            </button>
            <button onclick="switchTab('installation')" id="nav-installation" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="hammer" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">مرحلة التركيب</span>
            </button>
            
            <div class="my-3 border-t border-blue-800/30 mx-2"></div>
            
            <button onclick="switchTab('offers')" id="nav-offers" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="file-text" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">العروض والفواتير</span>
            </button>
            <button onclick="switchTab('reports')" id="nav-reports" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="layout-dashboard" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">التقارير</span>
            </button>
            <button onclick="switchTab('settings')" id="nav-settings" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 inactive-nav-item group">
                <i data-lucide="settings" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="font-medium text-sm">الإعدادات</span>
            </button>
        </nav>

        <!-- User Profile -->
        <div class="p-4 bg-[#0a2342]/80 backdrop-blur-sm mt-auto border-t border-blue-800/30">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center font-bold text-white shadow-md border border-white/10 relative">
                    خ
                    <span id="role-indicator" class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-400 border-2 border-[#0a2342] rounded-full"></span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-white truncate" id="user-name">خالد رمزي</p>
                    <p class="text-[10px] text-blue-300 truncate" id="user-role">مدير النظام</p>
                </div>
                <button onclick="toggleRole()" class="text-blue-300 hover:text-white p-1.5 rounded-lg hover:bg-white/10 transition-colors" title="تبديل الصلاحية">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-10 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden relative w-full bg-[#f8f9fc] dark:bg-slate-900 transition-colors">
        <!-- Header -->
        <header class="bg-white dark:bg-slate-800 shadow-sm h-16 flex items-center justify-between px-6 z-10 sticky top-0 border-b border-slate-100 dark:border-slate-700 transition-colors">
            <div class="flex items-center gap-4 flex-1">
                <button onclick="toggleSidebar()" class="md:hidden text-slate-500 dark:text-slate-400 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <div class="relative w-full max-w-lg hidden md:block group">
                    <i data-lucide="search" class="absolute right-3 top-2.5 h-5 w-5 text-slate-300 group-focus-within:text-blue-500 transition-colors"></i>
                    <input type="text" id="global-search" oninput="handleSearch(this.value)" placeholder="ابحث باسم العميل، رقم الهاتف، أو الكود..." 
                        class="w-full pr-10 pl-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:bg-white dark:focus:bg-slate-600 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 rounded-full text-sm transition-all outline-none text-slate-600 dark:text-slate-200 placeholder-slate-400">
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleDarkMode()" class="relative p-2.5 text-slate-500 hover:bg-slate-50 dark:text-slate-400 dark:hover:bg-slate-700 hover:text-blue-600 rounded-full transition-all" title="الوضع الليلي">
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                </button>

                <button onclick="resetData()" class="text-red-500 text-xs hover:bg-red-50 px-3 py-1.5 rounded-full transition-colors hidden md:block font-medium">إعادة تعيين</button>
                
                <button class="relative p-2.5 text-slate-500 hover:bg-slate-50 dark:text-slate-400 dark:hover:bg-slate-700 hover:text-blue-600 rounded-full transition-all">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-2 right-2.5 w-2 h-2 bg-red-500 rounded-full border-2 border-white"></span>
                </button>
                
                <button onclick="switchTab('registration')" class="hidden md:flex items-center gap-2 text-xs px-4 py-2 bg-[#0f3057] text-white rounded-lg hover:bg-[#1a4b82] transition shadow-sm hover:shadow active:scale-95 font-bold">
                    <i data-lucide="plus" class="w-4 h-4"></i> إضافة عميل
                </button>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 animate-fadeIn scroll-smooth">
            <!-- Content will be injected via JS -->
        </div>
    </main>

    <!-- Client Detail Modal -->
    <div id="clientModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <!-- Modal content injected via JS -->
    </div>

    <!-- JavaScript Application Logic -->
    <script>
        // --- Data & Constants ---
        const EMPLOYEES = [
            { id: 1, name: 'خالد رمزي', role: 'admin' },
            { id: 2, name: 'أحمد مندوب', role: 'sales' }
        ];

        let companySettings = {
            name: 'IN ONE OPERATION',
            subtitle: 'System Management',
            address: 'المملكة العربية السعودية - الرياض',
            phone: '920000000',
            email: 'info@inone.sa',
            taxId: '300000000000003',
            logo: '' 
        };

        let currentUser = EMPLOYEES[0]; // Start as Admin

        const INITIAL_CLIENTS = [
            { 
                id: 1, code: 'BK-5464', name: 'أحمد محمد', phone: '0501234567', 
                email: 'ahmed@email.com', address: 'الرياض - حي العليا', type: 'شركات',
                source: 'social', status: 'potential', employeeId: 1,
                projectDetails: { kitchen: 1, bedroom: 2, cladding: 0, doors: 5, vanity: 2, tvUnit: 1 },
                measurements: { status: 'pending', date: '', files: [] },
                design: { status: 'pending', total: 0, firstPayment: 0, signed: false },
                designImages: [],
                quotationItems: [],
                installation: { status: 'pending', jobNo: '', startDate: '', endDate: '', lastPayment: 0 },
                logs: [
                    { date: '2023-10-01', type: 'system', text: 'تم تسجيل العميل' },
                    { date: '2023-10-02', type: 'whatsapp', text: 'تم إرسال رسالة ترحيب' }
                ],
                invoices: []
            },
            { 
                id: 2, code: 'LD-9383', name: 'سارة علي', phone: '0559876543', 
                email: 'sara@email.com', address: 'جدة - الروضة', type: 'أفراد',
                source: 'referral', status: 'design', employeeId: 2,
                projectDetails: { kitchen: 1, bedroom: 0, cladding: 10, doors: 0, vanity: 3, tvUnit: 1 },
                measurements: { status: 'completed', date: '2025-02-15', files: ['croquis.pdf'] },
                design: { status: 'waiting_approval', total: 55000, firstPayment: 20000, signed: false },
                designImages: [],
                quotationItems: [
                    { name: 'أعمال تجليد خشب', qty: 10, price: 2500 },
                    { name: 'وحدة تلفاز', qty: 1, price: 5000 },
                    { name: 'خزائن ملابس', qty: 3, price: 8333.33 }
                ],
                installation: { status: 'pending', jobNo: '', startDate: '', endDate: '', lastPayment: 0 },
                logs: [
                     { date: '2023-10-05', type: 'system', text: 'تم رفع المقاسات' }
                ],
                invoices: [
                    { id: 101, date: '2025-02-20', amount: 20000, status: 'paid', type: 'دفعة أولى' }
                ]
            }
        ];

        const STATUS_OPTIONS = [
            { id: 'new', label: 'جديد', color: 'bg-blue-100 text-blue-700 border-blue-200' },
            { id: 'potential', label: 'محتمل', color: 'bg-yellow-100 text-yellow-700 border-yellow-200' },
            { id: 'measurements', label: 'جاري القياس', color: 'bg-purple-100 text-purple-700 border-purple-200' },
            { id: 'design', label: 'مرحلة التصميم', color: 'bg-indigo-100 text-indigo-700 border-indigo-200' },
            { id: 'installation', label: 'مرحلة التركيب', color: 'bg-orange-100 text-orange-700 border-orange-200' },
            { id: 'completed', label: 'مكتمل', color: 'bg-green-100 text-green-700 border-green-200' },
            { id: 'rejected', label: 'مرفوض', color: 'bg-red-100 text-red-700 border-red-200' },
        ];

        // --- State Management ---
        let clients = [];
        let activeTab = 'registration';
        let searchQuery = '';
        
        // Active Selections
        let selectedClientId = null;
        let selectedClientForDesignId = null;
        let selectedClientForPricingId = null;
        let selectedClientForInstallId = null;

        let newClientForm = {
            code: generateCode(),
            name: '', phone: '', whatsapp: '', email: '', address: '', location: '', 
            type: 'أفراد', source: 'social', taxId: '', clientStatus: 'potential',
            projectDetails: { kitchen: 0, bedroom: 0, cladding: 0, doors: 0, vanity: 0, tvUnit: 0 },
            customProjects: [], // For companies
            notes: '',
            measureRequest: { date: '', time: '', isPaid: false, amount: 0 }
        };

        // --- Initialization ---
        function init() {
            loadClients();
            loadSettings();
            initDarkMode();
            render();
            lucide.createIcons();
        }

        function loadClients() {
            const saved = localStorage.getItem('crm_clients_data');
            clients = saved ? JSON.parse(saved) : INITIAL_CLIENTS;
        }

        function saveClients() {
            localStorage.setItem('crm_clients_data', JSON.stringify(clients));
            render();
        }

        function loadSettings() {
            const saved = localStorage.getItem('crm_settings');
            if(saved) companySettings = JSON.parse(saved);
            updateSidebarInfo();
        }

        function saveSettingsData() {
            localStorage.setItem('crm_settings', JSON.stringify(companySettings));
            updateSidebarInfo();
            alert('تم حفظ الإعدادات بنجاح');
        }

        function updateSidebarInfo() {
            document.getElementById('company-name-display').textContent = companySettings.name;
            document.getElementById('company-subtitle-display').textContent = companySettings.subtitle;
            const logoContainer = document.getElementById('company-logo-container');
            if(companySettings.logo) logoContainer.innerHTML = `<img src="${companySettings.logo}" class="w-full h-full object-cover">`;
        }

        function initDarkMode() {
            if (localStorage.getItem('crm_dark_mode') === 'true' || (!('crm_dark_mode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('crm_dark_mode', isDark);
        }

        function generateCode() { return 'BK-' + Math.floor(1000 + Math.random() * 9000); }

        function toggleRole() {
            currentUser = currentUser.role === 'admin' ? EMPLOYEES[1] : EMPLOYEES[0];
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'مدير النظام' : 'مندوب مبيعات';
            document.getElementById('role-indicator').className = `absolute bottom-0 right-0 w-2.5 h-2.5 border-2 border-[#0a2342] rounded-full ${currentUser.role === 'admin' ? 'bg-green-400' : 'bg-yellow-400'}`;
            render();
        }

        function getVisibleClients() {
            let filtered = clients;
            if (currentUser.role !== 'admin') {
                filtered = filtered.filter(c => c.employeeId === currentUser.id);
            }
            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                filtered = filtered.filter(c => c.name.toLowerCase().includes(q) || c.phone.includes(q) || c.code.toLowerCase().includes(q));
            }
            return filtered;
        }

        function switchTab(tabName) {
            activeTab = tabName;
            
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('active-nav-item');
                btn.classList.add('inactive-nav-item');
                const icon = btn.querySelector('i') || btn.querySelector('svg');
                if(icon) {
                    icon.classList.remove('text-[#e5b57f]'); // Remove active color if any
                    icon.classList.add('opacity-70');
                }
            });

            const activeBtn = document.getElementById(`nav-${tabName}`);
            if (activeBtn) {
                activeBtn.classList.remove('inactive-nav-item');
                activeBtn.classList.add('active-nav-item');
                const activeIcon = activeBtn.querySelector('i') || activeBtn.querySelector('svg');
                if(activeIcon) {
                    activeIcon.classList.remove('opacity-70');
                    activeIcon.classList.add('text-[#e5b57f]');
                }
            }
            
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            }

            render();
        }

        function handleSearch(val) {
            searchQuery = val;
            render();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function resetData() {
            if(confirm('هل أنت متأكد؟ سيتم حذف جميع البيانات والعودة للوضع الافتراضي.')) {
                clients = INITIAL_CLIENTS;
                saveClients();
                location.reload();
            }
        }

        // --- Render Views ---

        function render() {
            const container = document.getElementById('content-area');
            const visibleClients = getVisibleClients();
            
            let html = '';
            
            if (activeTab === 'registration') {
                html = renderRegistrationView(visibleClients);
            } else if (activeTab === 'measurements') {
                html = renderMeasurementsView(visibleClients);
            } else if (activeTab === 'design') {
                html = renderDesignView(visibleClients);
            } else if (activeTab === 'pricing') {
                html = renderPricingView(visibleClients);
            } else if (activeTab === 'installation') {
                html = renderInstallationView(visibleClients);
            } else if (activeTab === 'offers') {
                html = renderOffersView(visibleClients);
            } else if (activeTab === 'reports') {
                html = renderReportsView(clients);
            } else if (activeTab === 'settings') {
                html = renderSettingsView();
            }

            container.innerHTML = html;
            lucide.createIcons();
            attachInputListeners();

            if (activeTab === 'reports') {
                initReportsCharts();
            }
        }

        // 1. Registration View
        function renderRegistrationView(data) {
            return `
                <div class="space-y-8">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                        ${renderStatCard('إجمالي العملاء', data.length, 'users', 'bg-gradient-to-br from-blue-500 to-blue-600', 'text-white')}
                        ${renderStatCard('مشاريع نشطة', data.filter(c => !['new','completed','rejected'].includes(c.status)).length, 'briefcase', 'bg-white', 'text-slate-800', 'border-l-4 border-yellow-500')}
                        ${renderStatCard('مشاريع مكتملة', data.filter(c => c.status === 'completed').length, 'check-circle', 'bg-white', 'text-slate-800', 'border-l-4 border-green-500')}
                        ${renderStatCard('جديد هذا الشهر', data.filter(c => c.status === 'new').length, 'star', 'bg-white', 'text-slate-800', 'border-l-4 border-purple-500')}
                    </div>

                    <!-- Add Client Form Card -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 relative overflow-hidden transition-colors">
                        <div class="absolute top-0 right-0 w-2 h-full bg-blue-600"></div>
                        <div class="mb-6 flex justify-between items-center border-b border-slate-100 dark:border-slate-700 pb-4">
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                <i data-lucide="user-plus" class="text-blue-600 w-6 h-6"></i>
                                بيانات العميل الجديد
                            </h2>
                            <span class="text-xs font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded">ID: ${newClientForm.code}</span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-6">
                            <div class="space-y-1">
                                <label class="form-label">الاسم الكامل <span class="text-red-500">*</span></label>
                                <input type="text" id="in-name" value="${newClientForm.name}" class="form-input" placeholder="اسم العميل...">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">رقم الجوال <span class="text-red-500">*</span></label>
                                <input type="text" id="in-phone" value="${newClientForm.phone}" class="form-input text-left dir-ltr font-mono" placeholder="05xxxxxxxx">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">رقم واتساب</label>
                                <input type="text" id="in-whatsapp" value="${newClientForm.whatsapp}" class="form-input text-left dir-ltr font-mono" placeholder="05xxxxxxxx">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">نوع العميل</label>
                                <select id="in-type" class="form-input bg-white dark:bg-slate-700">
                                    <option ${newClientForm.type === 'أفراد' ? 'selected' : ''}>أفراد</option>
                                    <option ${newClientForm.type === 'شركات' ? 'selected' : ''}>شركات</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">البريد الإلكتروني</label>
                                <input type="email" id="in-email" value="${newClientForm.email}" class="form-input" placeholder="example@mail.com">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">المصدر</label>
                                <select id="in-source" class="form-input bg-white dark:bg-slate-700">
                                    <option value="social" ${newClientForm.source === 'social' ? 'selected' : ''}>سوشيال ميديا</option>
                                    <option value="showroom" ${newClientForm.source === 'showroom' ? 'selected' : ''}>زيارة المعرض</option>
                                    <option value="website" ${newClientForm.source === 'website' ? 'selected' : ''}>موقع الكترونى</option>
                                    <option value="referral" ${newClientForm.source === 'referral' ? 'selected' : ''}>عن طريق صديق</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">الرقم الضريبي</label>
                                <input type="text" id="in-tax" value="${newClientForm.taxId}" class="form-input font-mono" placeholder="الرقم الضريبي للعميل">
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">حالة العميل</label>
                                <select id="in-status" class="form-input bg-white dark:bg-slate-700">
                                    <option value="potential" ${newClientForm.clientStatus === 'potential' ? 'selected' : ''}>محتمل</option>
                                    <option value="interested" ${newClientForm.clientStatus === 'interested' ? 'selected' : ''}>مهتم</option>
                                    <option value="inquiry" ${newClientForm.clientStatus === 'inquiry' ? 'selected' : ''}>استفسار</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="form-label">رابط اللوكيشن</label>
                                <input type="url" id="in-location" value="${newClientForm.location}" class="form-input text-left dir-ltr" placeholder="https://maps.google.com/...">
                            </div>
                            <div class="md:col-span-3 space-y-1">
                                <label class="form-label">العنوان</label>
                                <input type="text" id="in-address" value="${newClientForm.address}" class="form-input" placeholder="المدينة، الحي...">
                            </div>
                        </div>

                        <!-- Project Details Counter -->
                        <div class="bg-slate-50 dark:bg-slate-900 p-5 rounded-xl border border-dashed border-slate-300 dark:border-slate-600 mb-6">
                            <label class="text-sm font-bold text-slate-600 dark:text-slate-300 mb-4 block flex items-center gap-2">
                                <i data-lucide="layers" class="w-4 h-4 text-blue-500"></i> تفاصيل المشروع المطلوبة:
                            </label>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6 pb-6 border-b border-slate-200 dark:border-slate-700 border-dashed">
                                ${renderCounter('مطبخ', 'kitchen')}
                                ${renderCounter('غرفة نوم', 'bedroom')}
                                ${renderCounter('تجليد', 'cladding')}
                                ${renderCounter('وحدة TV', 'tvUnit')}
                                ${renderCounter('أبواب', 'doors')}
                                ${renderCounter('خزائن', 'vanity')}
                            </div>
                            <div class="space-y-3">
                                <label class="text-xs font-bold text-slate-500 dark:text-slate-400 block">بنود مخصصة (إضافة يدوية)</label>
                                <div class="flex gap-2 items-end">
                                    <div class="flex-1">
                                        <label class="text-xs text-slate-500 mb-1 block">اسم البند</label>
                                        <input type="text" id="comp-item-name" class="form-input" placeholder="مثال: مكتبة، دولاب..">
                                    </div>
                                    <div class="w-24">
                                        <label class="text-xs text-slate-500 mb-1 block">العدد</label>
                                        <input type="number" id="comp-item-qty" class="form-input" placeholder="0">
                                    </div>
                                    <button onclick="addCompanyItem()" class="bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 transition-colors h-[42px] w-[42px] flex items-center justify-center"><i data-lucide="plus" class="w-5 h-5"></i></button>
                                </div>
                                <div class="space-y-2 mt-3">
                                    ${newClientForm.customProjects.map((item, idx) => `
                                        <div class="flex justify-between items-center bg-white dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm">
                                            <span class="font-medium text-slate-700 dark:text-slate-200">${item.name}</span>
                                            <div class="flex items-center gap-4">
                                                <span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold">العدد: ${item.qty}</span>
                                                <button onclick="removeCompanyItem(${idx})" class="text-red-500 hover:bg-red-50 p-1.5 rounded transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${newClientForm.customProjects.length === 0 ? '<p class="text-sm text-slate-400 text-center py-2 italic">لم يتم إضافة بنود بعد</p>' : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Measurement Request Section -->
                        <div class="bg-blue-50/50 dark:bg-blue-900/20 p-5 rounded-xl border border-blue-100 dark:border-blue-800 mb-6">
                            <label class="text-sm font-bold text-blue-800 mb-4 block flex items-center gap-2">
                                <i data-lucide="calendar-clock" class="w-4 h-4 text-blue-600"></i> طلب رفع مقاسات (اختياري):
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-500">تاريخ الزيارة</label>
                                    <input type="date" id="in-measure-date" value="${newClientForm.measureRequest.date}" class="form-input">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-500">الوقت</label>
                                    <input type="time" id="in-measure-time" value="${newClientForm.measureRequest.time}" class="form-input">
                                </div>
                                <div class="flex items-center gap-2 h-[42px] bg-white dark:bg-slate-700 px-3 rounded-lg border border-slate-200 dark:border-slate-600">
                                    <input type="checkbox" id="in-measure-paid" onchange="togglePaidAmount()" ${newClientForm.measureRequest.isPaid ? 'checked' : ''} class="w-4 h-4 text-blue-600 rounded cursor-pointer">
                                    <label for="in-measure-paid" class="text-sm text-slate-700 dark:text-slate-200 cursor-pointer select-none">مدفوع؟</label>
                                </div>
                                <div id="measure-amount-div" class="space-y-1 ${newClientForm.measureRequest.isPaid ? '' : 'hidden'}">
                                    <label class="text-xs font-bold text-slate-500">المبلغ</label>
                                    <input type="number" id="in-measure-amount" value="${newClientForm.measureRequest.amount}" class="form-input" placeholder="0.00">
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-6">
                            <label class="form-label">ملاحظات أخرى</label>
                            <textarea id="in-notes" class="form-input h-24 resize-none" placeholder="أي تفاصيل إضافية...">${newClientForm.notes}</textarea>
                        </div>

                        <div class="flex flex-wrap gap-3 justify-end border-t border-slate-100 dark:border-slate-700 pt-4">
                            <button onclick="notifyClient()" class="bg-green-600 text-white px-6 py-2.5 rounded-lg hover:bg-green-700 flex items-center gap-2 shadow-lg shadow-green-900/20 transition-all active:scale-95 font-bold">
                                <i data-lucide="message-circle" class="w-4 h-4"></i> إشعار العميل
                            </button>
                            <button onclick="sendToMeasurements()" class="bg-purple-600 text-white px-6 py-2.5 rounded-lg hover:bg-purple-700 flex items-center gap-2 shadow-lg shadow-purple-900/20 transition-all active:scale-95 font-bold">
                                <i data-lucide="ruler" class="w-4 h-4"></i> إرسال لرفع المقاسات
                            </button>
                            <button onclick="saveNewClient()" class="bg-[#0f3057] text-white px-8 py-2.5 rounded-lg hover:bg-[#1a4b82] flex items-center gap-2 shadow-lg shadow-blue-900/20 transition-all active:scale-95 font-bold">
                                <i data-lucide="save" class="w-4 h-4"></i> حفظ البيانات
                            </button>
                        </div>
                    </div>

                    <!-- Clients Table -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden transition-colors">
                        <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                                <i data-lucide="list" class="w-5 h-5 text-slate-400"></i> سجل العملاء
                            </h3>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2.5 py-1 rounded-full font-bold">${data.length} عميل</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 font-medium">
                                    <tr>
                                        <th class="p-4">بيانات العميل</th>
                                        <th class="p-4">الجوال</th>
                                        <th class="p-4">المشاريع</th>
                                        <th class="p-4">الحالة</th>
                                        <th class="p-4 text-center">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                    ${data.map(c => `
                                        <tr class="hover:bg-blue-50/30 dark:hover:bg-slate-700/50 transition-colors group">
                                            <td class="p-4">
                                                <div class="font-bold text-[#0f3057] dark:text-blue-300 text-base">${c.name}</div>
                                                <div class="text-xs text-slate-400 font-mono flex items-center gap-1">
                                                    <span class="bg-slate-100 dark:bg-slate-700 px-1 rounded">${c.code}</span>
                                                    ${c.type === 'شركات' ? '<span class="bg-orange-100 text-orange-700 px-1 rounded">شركة</span>' : ''}
                                                </div>
                                            </td>
                                            <td class="p-4 font-mono dir-ltr text-right text-slate-600 dark:text-slate-300">${c.phone}</td>
                                            <td class="p-4">
                                                <div class="flex gap-1 flex-wrap">
                                                    ${Object.entries(c.projectDetails).map(([k, v]) => v > 0 ? 
                                                        `<span class="text-[10px] bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 px-1.5 py-0.5 rounded text-slate-600 dark:text-slate-300 shadow-sm">${k === 'kitchen' ? 'مطبخ' : k === 'bedroom' ? 'نوم' : k} <b class="text-blue-600 dark:text-blue-400">${v}</b></span>` 
                                                        : '').join('')}
                                                    ${(c.customProjects || []).map(p => 
                                                        `<span class="text-[10px] bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 px-1.5 py-0.5 rounded text-slate-600 dark:text-slate-300 shadow-sm">${p.name} <b class="text-blue-600 dark:text-blue-400">${p.qty}</b></span>`
                                                    ).join('')}
                                                </div>
                                            </td>
                                            <td class="p-4">
                                                <span class="px-2.5 py-1 rounded-full text-xs font-bold border ${getStatusColor(c.status)}">
                                                    ${getStatusLabel(c.status)}
                                                </span>
                                            </td>
                                            <td class="p-4">
                                                <div class="flex items-center justify-center gap-2">
                                                    <button onclick="openWhatsAppModal(${c.id})" class="p-2 text-green-600 bg-green-50 rounded-lg hover:bg-green-100 transition-colors" title="واتساب">
                                                        <i data-lucide="message-circle" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="openClientModal(${c.id})" class="p-2 text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors" title="التفاصيل">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${data.length === 0 ? '<div class="p-10 text-center text-slate-400 flex flex-col items-center"><i data-lucide="inbox" class="w-12 h-12 mb-2 opacity-20"></i>لا توجد بيانات للعرض</div>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // 2. Measurements View
        function renderMeasurementsView(data) {
            const selectedClient = selectedClientId ? clients.find(c => c.id == selectedClientId) : null;
            const projectDetails = selectedClient ? selectedClient.projectDetails : { kitchen: 0, bedroom: 0, cladding: 0, doors: 0, vanity: 0, tvUnit: 0 };
            const appointment = selectedClient?.appointment || { date: '', time: '', status: 'pending' };
            
            return `
                <div class="space-y-6 max-w-5xl mx-auto">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-8 border-t-4 border-t-indigo-500 transition-colors">
                        <div class="mb-8 border-b border-slate-100 dark:border-slate-700 pb-4">
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-3">
                                <span class="p-2 bg-indigo-100 rounded-lg text-indigo-600"><i data-lucide="ruler" class="w-6 h-6"></i></span>
                                تفاصيل المشروع والمقاسات
                            </h2>
                            <p class="text-slate-500 mt-1 mr-12 text-sm">إدارة ملفات الرفع المساحي والوسائط</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="space-y-1">
                                <label class="form-label">اسم العميل</label>
                                <div class="relative">
                                    <select onchange="selectClientForMeasure(this.value)" class="form-input appearance-none bg-white dark:bg-slate-700 cursor-pointer">
                                        <option value="">اختر عميل...</option>
                                        ${clients.map(c => `<option value="${c.id}" ${c.id == selectedClientId ? 'selected' : ''}>${c.name} (${c.code})</option>`).join('')}
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute left-3 top-3 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>
                             <div class="space-y-1">
                                <label class="form-label">رقم الجوال</label>
                                <input type="text" value="${selectedClient ? selectedClient.phone : ''}" readonly class="form-input bg-slate-50 dark:bg-slate-900 text-slate-500">
                            </div>
                             <div class="space-y-1">
                                <label class="form-label">حالة المقاسات</label>
                                <div class="form-input bg-slate-50 dark:bg-slate-900 flex items-center justify-between">
                                    <span class="${selectedClient && selectedClient.measurements.status === 'completed' ? 'text-green-600 font-bold' : 'text-slate-500'}">
                                        ${selectedClient ? (selectedClient.measurements.status === 'completed' ? 'مكتمل' : 'معلق') : '-'}
                                    </span>
                                    ${selectedClient && selectedClient.measurements.status === 'completed' ? '<i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>' : ''}
                                </div>
                            </div>
                        </div>

                        <!-- 1. Appointment Section -->
                        <div class="bg-blue-50/50 dark:bg-blue-900/20 p-6 rounded-xl border border-blue-100 dark:border-blue-800 mb-8 ${!selectedClient ? 'opacity-50 pointer-events-none' : ''}">
                            <h4 class="text-sm font-bold text-blue-800 mb-4 flex items-center gap-2">
                                <i data-lucide="calendar-clock" class="w-4 h-4"></i> تحديد موعد القياس
                            </h4>
                            <div class="flex flex-wrap items-end gap-4">
                                <div class="space-y-1 flex-1 min-w-[200px]">
                                    <label class="text-xs font-bold text-slate-500">تاريخ الزيارة</label>
                                    <input type="date" id="measure-date" value="${appointment.date}" class="form-input">
                                </div>
                                <div class="space-y-1 flex-1 min-w-[150px]">
                                    <label class="text-xs font-bold text-slate-500">وقت الزيارة</label>
                                    <input type="time" id="measure-time" value="${appointment.time}" class="form-input">
                                </div>
                                <button onclick="saveAppointment()" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 shadow-sm font-bold transition-colors h-[42px]">
                                    حفظ الموعد
                                </button>
                            </div>
                        </div>

                        <!-- 2. Measurement Items Uploads -->
                        <div class="space-y-6 mb-8 ${!selectedClient ? 'opacity-50 pointer-events-none' : ''}">
                            <div class="flex items-center justify-between">
                                <label class="form-label text-base">تفاصيل الرفع المساحي (صور/فيديو + كروكي):</label>
                                <span class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded">يتم الرفع لكل بند على حدة</span>
                            </div>
                            
                            <div class="grid grid-cols-1 gap-4">
                                ${selectedClient ? getMeasurementItems(selectedClient).map(item => `
                                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm hover:border-indigo-300 transition-colors">
                                        <h5 class="font-bold text-slate-700 dark:text-slate-200 mb-3 flex items-center gap-2">
                                            <span class="w-2 h-2 rounded-full bg-indigo-500"></span> ${item.label}
                                        </h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="upload-zone bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 p-4 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-all h-32">
                                                <i data-lucide="image" class="w-6 h-6 text-slate-400 mb-2"></i>
                                                <span class="text-xs font-bold text-slate-600">صور/فيديو الموقع (قبل)</span>
                                                <span class="text-[10px] text-slate-400 mt-1">JPG, MP4</span>
                                            </div>
                                            <div class="upload-zone bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 p-4 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-purple-50 hover:border-purple-300 transition-all h-32">
                                                <i data-lucide="pen-tool" class="w-6 h-6 text-slate-400 mb-2"></i>
                                                <span class="text-xs font-bold text-slate-600">كروكي المقاسات</span>
                                                <span class="text-[10px] text-slate-400 mt-1">PDF, PNG</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : '<div class="text-center py-8 text-slate-400 bg-slate-50 dark:bg-slate-900 rounded-xl border border-dashed border-slate-200 dark:border-slate-700">اختر عميلاً لعرض البنود</div>'}
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-3 justify-end pt-4 border-t border-slate-100 dark:border-slate-700 ${!selectedClient ? 'opacity-50 pointer-events-none' : ''}">
                            <button onclick="notifyClientMeasurement()" class="bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 shadow-lg shadow-green-900/20 flex items-center gap-2 font-bold transition-all active:scale-95">
                                <i data-lucide="message-circle" class="w-4 h-4"></i> إشعار العميل
                            </button>
                            <button onclick="sendToDesign()" class="bg-purple-600 text-white px-5 py-2.5 rounded-lg hover:bg-purple-700 shadow-lg shadow-purple-900/20 flex items-center gap-2 font-bold transition-all active:scale-95">
                                <i data-lucide="send" class="w-4 h-4"></i> إرسال للتصميم
                            </button>
                            <button onclick="handleSaveMeasurements()" class="bg-[#0f3057] text-white px-6 py-2.5 rounded-lg hover:bg-[#1a4b82] shadow-lg shadow-blue-900/20 flex items-center gap-2 font-bold transition-all active:scale-95">
                                <i data-lucide="save" class="w-4 h-4"></i> تم رفع المقاسات
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 3. Design View
        function renderDesignView(data) {
            const selectedClient = selectedClientForDesignId ? clients.find(c => c.id == selectedClientForDesignId) : null;

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-140px)]">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 border-t-4 border-t-purple-500 h-full overflow-y-auto custom-scrollbar transition-colors">
                            <div class="mb-6 border-b border-slate-100 dark:border-slate-700 pb-4">
                                <h2 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                    <span class="p-2 bg-purple-100 rounded-lg text-purple-600"><i data-lucide="pen-tool" class="w-5 h-5"></i></span>
                                    مرحلة التصميم
                                </h2>
                            </div>
                            
                            <div class="space-y-4 mb-6">
                                <label class="form-label">اختيار العميل</label>
                                <div class="relative">
                                    <select onchange="selectClientForDesign(this.value)" class="form-input appearance-none bg-slate-50 dark:bg-slate-700 cursor-pointer">
                                        <option value="">اختر عميل...</option>
                                        ${clients.map(c => `<option value="${c.id}" ${c.id == selectedClientForDesignId ? 'selected' : ''}>${c.name} - ${getStatusLabel(c.status)}</option>`).join('')}
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <div class="space-y-6 ${!selectedClient ? 'opacity-50 pointer-events-none filter blur-sm transition-all' : 'transition-all'}">
                                <!-- Design Status & Files Placeholder -->
                                <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                                    <div class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-6 flex flex-col items-center justify-center text-center hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors relative cursor-pointer">
                                        <input type="file" multiple accept="image/*" onchange="handleDesignImageUpload(this)" class="absolute inset-0 opacity-0 cursor-pointer">
                                        <i data-lucide="upload-cloud" class="w-10 h-10 text-purple-500 mb-2"></i>
                                        <p class="text-sm font-bold text-slate-600 dark:text-slate-300">اضغط لرفع صور التصميم (Mockups)</p>
                                        <p class="text-xs text-slate-400 mt-1">JPG, PNG (Max 5MB)</p>
                                    </div>
                                    
                                    <!-- Gallery Grid -->
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mt-4">
                                        ${(selectedClient?.designImages || []).map((img, idx) => `
                                            <div class="relative group aspect-video bg-white dark:bg-slate-800 rounded-lg overflow-hidden border border-slate-200 dark:border-slate-600 shadow-sm">
                                                <img src="${img}" class="w-full h-full object-cover transition-transform group-hover:scale-105">
                                                <button onclick="deleteDesignImage(${idx})" class="absolute top-2 right-2 bg-red-500/90 hover:bg-red-600 text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-all shadow-sm transform scale-90 group-hover:scale-100"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </div>
                                        `).join('')}
                                        ${(!selectedClient?.designImages || selectedClient.designImages.length === 0) ? '<p class="col-span-full text-center text-xs text-slate-400 py-4">لا توجد صور مرفقة</p>' : ''}
                                    </div>
                                </div>

                                <div class="pt-6 border-t border-slate-100 dark:border-slate-700">
                                    <div class="flex gap-3 mt-6">
                                        <button onclick="switchTab('pricing'); selectClientForPricing(${selectedClient?.id})" class="flex-1 bg-purple-600 text-white hover:bg-purple-700 py-3 rounded-lg font-bold transition shadow-lg shadow-purple-200 flex justify-center gap-2">
                                            <i data-lucide="arrow-right" class="w-5 h-5"></i> الانتقال للتسعير
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-1 space-y-4">
                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 h-full flex flex-col transition-colors">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4 border-b dark:border-slate-700 pb-2">ملف العميل المختصر</h3>
                            <div class="flex-1">
                                ${selectedClient ? `
                                    <div class="text-center mb-6">
                                        <div class="w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl font-bold text-slate-600 dark:text-slate-300">
                                            ${selectedClient.name.charAt(0)}
                                        </div>
                                        <p class="font-bold text-lg text-slate-800 dark:text-white">${selectedClient.name}</p>
                                        <p class="text-sm text-slate-400 font-mono">${selectedClient.code}</p>
                                    </div>
                                    <div class="space-y-3 bg-slate-50 dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-700 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-slate-500">الحالة الحالية:</span> 
                                            <span class="font-bold px-2 py-0.5 rounded bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 text-xs">${getStatusLabel(selectedClient.status)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-500">المقاسات:</span> 
                                            <span class="font-bold ${selectedClient.measurements.status === 'completed' ? 'text-green-600' : 'text-orange-500'}">
                                                ${selectedClient.measurements.status === 'completed' ? 'تمت' : 'لم تتم'}
                                            </span>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="h-full flex flex-col items-center justify-center text-slate-300">
                                        <i data-lucide="user" class="w-16 h-16 mb-2 opacity-50"></i>
                                        <p>اختر عميلاً لعرض التفاصيل</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // New Pricing View
        function renderPricingView(data) {
            const selectedClient = selectedClientForPricingId ? clients.find(c => c.id == selectedClientForPricingId) : null;
            const items = selectedClient ? (selectedClient.quotationItems || []) : [];
            const totalAmount = items.reduce((sum, item) => sum + (item.qty * item.price), 0);

            return `
                <div class="space-y-6 max-w-6xl mx-auto">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 border-t-4 border-t-green-500 transition-colors">
                        <div class="mb-6 border-b border-slate-100 dark:border-slate-700 pb-4 flex justify-between items-center">
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                <span class="p-2 bg-green-100 rounded-lg text-green-600"><i data-lucide="calculator" class="w-5 h-5"></i></span>
                                إعداد عرض السعر التفصيلي
                            </h2>
                        </div>

                        <div class="mb-6">
                            <label class="form-label">اختيار العميل</label>
                            <div class="relative max-w-md">
                                <select onchange="selectClientForPricing(this.value)" class="form-input appearance-none bg-slate-50 dark:bg-slate-700 cursor-pointer">
                                    <option value="">اختر عميل...</option>
                                    ${clients.map(c => `<option value="${c.id}" ${c.id == selectedClientForPricingId ? 'selected' : ''}>${c.name} (${c.code})</option>`).join('')}
                                </select>
                                <i data-lucide="chevron-down" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="${!selectedClient ? 'opacity-50 pointer-events-none filter blur-sm' : ''} transition-all">
                            <!-- Items Table -->
                            <div class="bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden mb-6">
                                <table class="w-full text-right text-sm">
                                    <thead class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold">
                                        <tr>
                                            <th class="p-3 w-12">#</th>
                                            <th class="p-3">البند / الوصف</th>
                                            <th class="p-3 w-24">الكمية</th>
                                            <th class="p-3 w-32">السعر الإفرادي</th>
                                            <th class="p-3 w-32">الإجمالي</th>
                                            <th class="p-3 w-16"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                        ${items.map((item, idx) => `
                                            <tr class="bg-white dark:bg-slate-800">
                                                <td class="p-3 text-center text-slate-400">${idx + 1}</td>
                                                <td class="p-3"><input type="text" value="${item.name}" onchange="updatePricingItem(${idx}, 'name', this.value)" class="w-full bg-transparent outline-none border-b border-transparent focus:border-blue-500 transition-colors" placeholder="اسم البند..."></td>
                                                <td class="p-3"><input type="number" value="${item.qty}" onchange="updatePricingItem(${idx}, 'qty', this.value)" class="w-full bg-transparent outline-none border-b border-transparent focus:border-blue-500 transition-colors text-center" min="1"></td>
                                                <td class="p-3"><input type="number" value="${item.price}" onchange="updatePricingItem(${idx}, 'price', this.value)" class="w-full bg-transparent outline-none border-b border-transparent focus:border-blue-500 transition-colors" step="0.01"></td>
                                                <td class="p-3 font-bold text-slate-700 dark:text-slate-200">${(item.qty * item.price).toLocaleString()}</td>
                                                <td class="p-3 text-center"><button onclick="removePricingItem(${idx})" class="text-red-400 hover:text-red-600"><i data-lucide="trash" class="w-4 h-4"></i></button></td>
                                            </tr>
                                        `).join('')}
                                        <tr class="bg-slate-50 dark:bg-slate-900">
                                            <td colspan="6" class="p-2 text-center">
                                                <button onclick="addPricingItem()" class="text-blue-600 hover:text-blue-700 font-bold text-sm flex items-center justify-center gap-2 w-full py-2 hover:bg-blue-50 dark:hover:bg-slate-800 rounded transition-colors">
                                                    <i data-lucide="plus-circle" class="w-4 h-4"></i> إضافة بند جديد
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Summary & Actions -->
                            <div class="flex flex-col md:flex-row justify-between items-end gap-6">
                                <div class="w-full md:w-1/3 space-y-4">
                                     <div class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl p-4 flex items-start gap-3">
                                        <input type="checkbox" id="signed-pricing" ${selectedClient?.design.signed ? 'checked' : ''} class="w-5 h-5 text-green-600 rounded mt-0.5 cursor-pointer accent-green-600">
                                        <div>
                                            <label for="signed-pricing" class="font-bold text-slate-700 dark:text-slate-200 select-none cursor-pointer block">اعتماد العرض وتوقيع العقد</label>
                                            <p class="text-xs text-slate-500 mt-1">تفعيل هذا الخيار ينقل العميل لمرحلة التنفيذ.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-slate-100 dark:bg-slate-900 p-5 rounded-xl min-w-[300px] space-y-3">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-500">المجموع الكلي:</span>
                                        <span class="font-bold text-lg text-slate-800 dark:text-white">${totalAmount.toLocaleString()} <span class="text-xs font-normal">SAR</span></span>
                                    </div>
                                    <div class="flex justify-between items-center gap-4">
                                        <span class="text-slate-500 text-sm">الدفعة الأولى:</span>
                                        <input type="number" id="pricing-first-payment" value="${selectedClient?.design.firstPayment || 0}" class="w-24 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded px-2 py-1 text-sm font-bold" placeholder="0">
                                    </div>
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="printDetailedQuotation(${selectedClient?.id})" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-900/20 flex justify-center gap-2" title="طباعة PDF">
                                            <i data-lucide="printer" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="savePricingData()" class="flex-[2] bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700 transition shadow-lg shadow-green-900/20 flex justify-center gap-2">
                                            <i data-lucide="save" class="w-4 h-4"></i> حفظ العرض
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 4. Installation View
        function renderInstallationView(data) {
            const selectedClient = selectedClientForInstallId ? clients.find(c => c.id == selectedClientForInstallId) : null;

            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                          <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 border-t-4 border-t-orange-500 transition-colors">
                            <div class="flex justify-between items-center mb-6">
                              <h3 class="font-bold text-slate-800 dark:text-white text-lg flex items-center gap-2">
                                <span class="p-2 bg-orange-100 rounded-lg text-orange-600"><i data-lucide="wrench" class="w-5 h-5"></i></span>
                                تفاصيل المشروع والتركيب
                              </h3>
                            </div>

                            <div class="mb-6">
                                <label class="form-label">اختيار العميل (مرحلة التركيب)</label>
                                <div class="relative">
                                    <select onchange="selectClientForInstall(this.value)" class="form-input appearance-none bg-slate-50 dark:bg-slate-700 cursor-pointer">
                                        <option value="">اختر عميل...</option>
                                        ${clients.filter(c => c.design.signed).map(c => `<option value="${c.id}" ${c.id == selectedClientForInstallId ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 ${!selectedClient ? 'opacity-50 pointer-events-none filter blur-sm' : ''}">
                              <div class="space-y-1">
                                <label class="form-label">رقم الوظيفة (Job No)</label>
                                <input type="text" id="install-job" value="${selectedClient?.installation.jobNo || ''}" class="form-input bg-slate-50 dark:bg-slate-700 text-right font-mono" placeholder="J-XXXX">
                              </div>
                              <div class="space-y-1">
                                <label class="form-label">تاريخ بدء التركيب</label>
                                <input type="date" id="install-start" value="${selectedClient?.installation.startDate || ''}" class="form-input">
                              </div>
                              <div class="space-y-1">
                                <label class="form-label">الدفعة الأخيرة (ريال)</label>
                                <div class="relative">
                                    <input type="number" id="install-last-pay" value="${selectedClient?.installation.lastPayment || ''}" class="form-input pr-10" placeholder="0">
                                    <span class="absolute left-3 top-2.5 text-xs text-slate-400 font-bold">SAR</span>
                                </div>
                              </div>
                            </div>

                            <div class="mt-8 flex gap-3 justify-end pt-4 border-t border-slate-100 dark:border-slate-700">
                               <button onclick="handleSaveInstallation()" class="bg-orange-500 text-white px-6 py-2.5 rounded-lg hover:bg-orange-600 flex items-center gap-2 shadow-lg shadow-orange-200 transition-all font-bold ${!selectedClient ? 'hidden' : ''}">
                                   <i data-lucide="calendar-check" class="w-5 h-5"></i> تحديث وجدولة
                               </button>
                            </div>
                          </div>
                        </div>
                        
                        <div class="lg:col-span-1 space-y-4">
                             <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 transition-colors">
                                <h4 class="font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4"></i> إحصائيات التركيب</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg border border-blue-100">
                                        <span class="text-sm text-blue-800">بالانتظار</span>
                                        <span class="bg-white px-2 py-0.5 rounded text-blue-600 font-bold shadow-sm">${clients.filter(c => c.status === 'design' && c.design.signed).length}</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg border border-orange-100">
                                        <span class="text-sm text-orange-800">جاري التركيب</span>
                                        <span class="bg-white px-2 py-0.5 rounded text-orange-600 font-bold shadow-sm">${clients.filter(c => c.status === 'installation').length}</span>
                                    </div>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 5. Offers View
        function renderOffersView(data) {
            const offers = clients.filter(c => c.design.total > 0);
            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        ${renderStatCard('إجمالي العروض', offers.length, 'file-text', 'bg-blue-600', 'text-white')}
                        ${renderStatCard('قيمة العروض', offers.reduce((a,b) => a + (parseInt(b.design.total)||0), 0).toLocaleString() + ' ريال', 'dollar-sign', 'bg-white', 'text-slate-800', 'border-l-4 border-green-500')}
                        ${renderStatCard('تم التعاقد', offers.filter(c => c.design.signed).length, 'check-circle', 'bg-white', 'text-slate-800', 'border-l-4 border-purple-500')}
                    </div>

                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden transition-colors">
                        <div class="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200">قائمة عروض الأسعار والفواتير</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 border-b border-slate-100 dark:border-slate-700">
                                    <tr>
                                        <th class="p-4">رقم العرض</th>
                                        <th class="p-4">العميل</th>
                                        <th class="p-4">القيمة الإجمالية</th>
                                        <th class="p-4">الدفعة الأولى</th>
                                        <th class="p-4">الحالة</th>
                                        <th class="p-4 text-center">إجراء</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                    ${offers.length > 0 ? offers.map(c => `
                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                            <td class="p-4 font-mono text-slate-500">${c.code}-QT</td>
                                            <td class="p-4 font-bold text-slate-800 dark:text-slate-200">${c.name}</td>
                                            <td class="p-4 text-slate-800 dark:text-slate-200 font-bold">${parseInt(c.design.total).toLocaleString()} ريال</td>
                                            <td class="p-4 text-green-600">${parseInt(c.design.firstPayment).toLocaleString()} ريال</td>
                                            <td class="p-4">
                                                <span class="px-2.5 py-1 rounded-full text-xs font-bold ${c.design.signed ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                                    ${c.design.signed ? 'تم التعاقد' : 'بانتظار الموافقة'}
                                                </span>
                                            </td>
                                            <td class="p-4 text-center">
                                                <button onclick="printInvoice(${c.id})" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-colors" title="طباعة عرض السعر">
                                                    <i data-lucide="printer" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="printReceipt(${c.id})" class="text-green-600 hover:bg-green-50 p-2 rounded-lg transition-colors" title="طباعة سند قبض">
                                                    <i data-lucide="banknote" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="6" class="text-center py-10 text-slate-400">لا توجد عروض أسعار مسجلة</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // 6. Reports View
        function renderReportsView(data) {
            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Status Chart -->
                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 transition-colors">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">توزيع حالات المشاريع</h3>
                            <div class="relative h-64">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>

                        <!-- Financial Chart -->
                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 transition-colors">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">الملخص المالي</h3>
                            <div class="relative h-64">
                                <canvas id="financialChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm transition-colors">
                            <p class="text-sm text-slate-500 dark:text-slate-400">إجمالي العقود</p>
                            <p class="text-2xl font-bold text-slate-800 dark:text-white" id="report-total-contracts">0 ريال</p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm transition-colors">
                            <p class="text-sm text-slate-500 dark:text-slate-400">المحصل</p>
                            <p class="text-2xl font-bold text-green-600" id="report-total-collected">0 ريال</p>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm transition-colors">
                            <p class="text-sm text-slate-500 dark:text-slate-400">المتبقي</p>
                            <p class="text-2xl font-bold text-red-500" id="report-total-remaining">0 ريال</p>
                        </div>
                         <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm transition-colors">
                            <p class="text-sm text-slate-500 dark:text-slate-400">عدد العملاء</p>
                            <p class="text-2xl font-bold text-blue-600">${data.length}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // 7. Settings View
        function renderSettingsView() {
            return `
                <div class="max-w-4xl mx-auto space-y-6 animate-fadeIn">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-8 transition-colors">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2">
                            <i data-lucide="settings" class="w-6 h-6 text-slate-400"></i>
                            إعدادات النظام والشركة
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Logo Upload -->
                            <div class="space-y-4">
                                <label class="form-label">شعار الشركة</label>
                                <div class="flex flex-col items-center justify-center border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-6 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors relative">
                                    <div id="settings-logo-preview" class="w-32 h-32 bg-slate-100 dark:bg-slate-900 rounded-xl flex items-center justify-center mb-4 overflow-hidden shadow-sm">
                                        ${companySettings.logo ? `<img src="${companySettings.logo}" class="w-full h-full object-cover">` : '<i data-lucide="image" class="w-10 h-10 text-slate-300"></i>'}
                                    </div>
                                    <input type="file" id="logo-upload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleLogoUpload(this)">
                                    <p class="text-sm text-slate-500 font-medium">اضغط لتغيير الشعار</p>
                                    <p class="text-xs text-slate-400 mt-1">PNG, JPG (Max 2MB)</p>
                                </div>
                            </div>

                            <!-- Company Info -->
                            <div class="space-y-4">
                                <div class="space-y-1">
                                    <label class="form-label">اسم الشركة</label>
                                    <input type="text" id="set-name" value="${companySettings.name}" class="form-input">
                                </div>
                                <div class="space-y-1">
                                    <label class="form-label">وصف مختصر (تحت الشعار)</label>
                                    <input type="text" id="set-subtitle" value="${companySettings.subtitle}" class="form-input">
                                </div>
                                <div class="space-y-1">
                                    <label class="form-label">رقم الهاتف</label>
                                    <input type="text" id="set-phone" value="${companySettings.phone}" class="form-input dir-ltr text-right">
                                </div>
                                <div class="space-y-1">
                                    <label class="form-label">البريد الإلكتروني</label>
                                    <input type="email" id="set-email" value="${companySettings.email}" class="form-input dir-ltr text-right">
                                </div>
                            </div>

                            <!-- Address & Tax -->
                            <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-1">
                                    <label class="form-label">العنوان</label>
                                    <input type="text" id="set-address" value="${companySettings.address}" class="form-input">
                                </div>
                                <div class="space-y-1">
                                    <label class="form-label">الرقم الضريبي</label>
                                    <input type="text" id="set-tax" value="${companySettings.taxId}" class="form-input font-mono">
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 pt-6 border-t border-slate-100 dark:border-slate-700 flex justify-end">
                            <button onclick="saveSettingsFromView()" class="bg-[#0f3057] text-white px-8 py-3 rounded-lg hover:bg-[#1a4b82] shadow-lg shadow-blue-900/20 font-bold flex items-center gap-2">
                                <i data-lucide="save" class="w-5 h-5"></i> حفظ الإعدادات
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Helper Renderers ---
        function renderStatCard(title, val, icon, bgClass, textClass, borderClass = '') {
            return `
                <div class="rounded-xl shadow-sm p-5 flex justify-between items-center ${bgClass} ${bgClass.includes('bg-white') ? 'dark:bg-slate-800' : ''} ${borderClass} transition-transform hover:-translate-y-1">
                    <div class="${textClass}">
                        <p class="text-sm opacity-80 font-medium mb-1">${title}</p>
                        <p class="text-3xl font-bold">${val}</p>
                    </div>
                    <div class="p-3 rounded-lg bg-white/20 backdrop-blur-sm ${textClass}">
                        <i data-lucide="${icon}" class="w-6 h-6"></i>
                    </div>
                </div>
            `;
        }

        function renderCounter(label, key) {
            return `
                <div class="flex flex-col bg-white dark:bg-slate-800 p-2 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm">
                    <span class="text-xs font-bold text-slate-500 mb-2 text-center block">${label}</span>
                    <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-900 rounded">
                        <button onclick="updateCount('${key}', -1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors font-bold text-lg">-</button>
                        <span id="count-${key}" class="font-bold text-slate-700 dark:text-slate-200 text-sm">${newClientForm.projectDetails[key]}</span>
                        <button onclick="updateCount('${key}', 1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-green-500 hover:bg-green-50 rounded transition-colors font-bold text-lg">+</button>
                    </div>
                </div>
            `;
        }

        function renderUploadZone(icon, label, subLabel, styleClass) {
            // styleClass example: 'bg-blue-50 border-blue-200 text-blue-500'
            const [bg, border, text] = styleClass.split(' ');
            return `
                <div class="upload-zone ${bg} ${border} p-8 text-center cursor-pointer group">
                    <div class="flex justify-center mb-3">
                        <div class="p-4 bg-white rounded-full shadow-sm group-hover:scale-110 transition-transform duration-200">
                            <i data-lucide="${icon}" class="${text} w-6 h-6"></i>
                        </div>
                    </div>
                    <h4 class="font-bold text-slate-700 mb-1 group-hover:text-blue-600 transition-colors">${label}</h4>
                    <p class="text-xs text-slate-400">${subLabel}</p>
                </div>
            `;
        }

        function getStatusLabel(s) { const o = STATUS_OPTIONS.find(x => x.id === s); return o ? o.label : s; }
        function getStatusColor(s) { const o = STATUS_OPTIONS.find(x => x.id === s); return o ? o.color : 'bg-gray-100'; }

        // --- Logic Handlers ---
        function attachInputListeners() {
            const n = document.getElementById('in-name'), p = document.getElementById('in-phone'), e = document.getElementById('in-email'), a = document.getElementById('in-address'), t = document.getElementById('in-type');
            const w = document.getElementById('in-whatsapp'), l = document.getElementById('in-location'), s = document.getElementById('in-source'), tx = document.getElementById('in-tax'), st = document.getElementById('in-status'), nt = document.getElementById('in-notes');
            const md = document.getElementById('in-measure-date'), mt = document.getElementById('in-measure-time'), ma = document.getElementById('in-measure-amount');

            if(n) n.oninput = (ev) => newClientForm.name = ev.target.value;
            if(p) p.oninput = (ev) => newClientForm.phone = ev.target.value;
            if(e) e.oninput = (ev) => newClientForm.email = ev.target.value;
            if(a) a.oninput = (ev) => newClientForm.address = ev.target.value;
            if(t) t.onchange = (ev) => { newClientForm.type = ev.target.value; render(); };
            if(w) w.oninput = (ev) => newClientForm.whatsapp = ev.target.value;
            if(l) l.oninput = (ev) => newClientForm.location = ev.target.value;
            if(s) s.onchange = (ev) => newClientForm.source = ev.target.value;
            if(tx) tx.oninput = (ev) => newClientForm.taxId = ev.target.value;
            if(st) st.onchange = (ev) => newClientForm.clientStatus = ev.target.value;
            if(nt) nt.oninput = (ev) => newClientForm.notes = ev.target.value;
            if(md) md.oninput = (ev) => newClientForm.measureRequest.date = ev.target.value;
            if(mt) mt.oninput = (ev) => newClientForm.measureRequest.time = ev.target.value;
            if(ma) ma.oninput = (ev) => newClientForm.measureRequest.amount = ev.target.value;
        }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    companySettings.logo = e.target.result;
                    document.getElementById('settings-logo-preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveSettingsFromView() {
            companySettings.name = document.getElementById('set-name').value;
            companySettings.subtitle = document.getElementById('set-subtitle').value;
            companySettings.phone = document.getElementById('set-phone').value;
            companySettings.email = document.getElementById('set-email').value;
            companySettings.address = document.getElementById('set-address').value;
            companySettings.taxId = document.getElementById('set-tax').value;
            saveSettingsData();
        }

        function initReportsCharts() {
            const ctxStatus = document.getElementById('statusChart');
            const ctxFinancial = document.getElementById('financialChart');
            
            if(!ctxStatus || !ctxFinancial) return;

            // Data Processing
            const statusCounts = {};
            STATUS_OPTIONS.forEach(s => statusCounts[s.id] = 0);
            clients.forEach(c => {
                if(statusCounts[c.status] !== undefined) statusCounts[c.status]++;
                else statusCounts[c.status] = 1; // Fallback
            });

            const totalContracts = clients.reduce((sum, c) => sum + (parseInt(c.design.total) || 0), 0);
            const totalCollected = clients.reduce((sum, c) => sum + (parseInt(c.design.firstPayment) || 0) + (parseInt(c.installation.lastPayment) || 0), 0);
            const totalRemaining = totalContracts - totalCollected;

            // Update Summary Cards
            document.getElementById('report-total-contracts').textContent = totalContracts.toLocaleString() + ' ريال';
            document.getElementById('report-total-collected').textContent = totalCollected.toLocaleString() + ' ريال';
            document.getElementById('report-total-remaining').textContent = totalRemaining.toLocaleString() + ' ريال';

            // Status Chart
            new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: STATUS_OPTIONS.map(s => s.label),
                    datasets: [{
                        data: STATUS_OPTIONS.map(s => statusCounts[s.id]),
                        backgroundColor: ['#3b82f6', '#eab308', '#a855f7', '#6366f1', '#f97316', '#22c55e', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { family: 'Cairo' } } } } }
            });

            // Financial Chart
            new Chart(ctxFinancial, {
                type: 'bar',
                data: {
                    labels: ['إجمالي العقود', 'المحصل', 'المتبقي'],
                    datasets: [{
                        label: 'القيم المالية (ريال)',
                        data: [totalContracts, totalCollected, totalRemaining],
                        backgroundColor: ['#3b82f6', '#22c55e', '#ef4444'],
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function updateCount(k, d) {
            newClientForm.projectDetails[k] = Math.max(0, newClientForm.projectDetails[k] + d);
            render(); 
        }

        function addCompanyItem() {
            const name = document.getElementById('comp-item-name').value;
            const qty = document.getElementById('comp-item-qty').value;
            if(name && qty > 0) {
                newClientForm.customProjects.push({ name, qty });
                render();
            }
        }

        function removeCompanyItem(idx) {
            newClientForm.customProjects.splice(idx, 1);
            render();
        }

        function togglePaidAmount() {
            const isPaid = document.getElementById('in-measure-paid').checked;
            newClientForm.measureRequest.isPaid = isPaid;
            render();
        }

        function saveNewClient(targetStatus = null) {
            if(!newClientForm.name || !newClientForm.phone) return alert('الاسم ورقم الجوال مطلوبان');
            if(clients.some(c => c.phone === newClientForm.phone)) return alert('رقم الجوال مسجل مسبقاً!');

            const client = {
                ...newClientForm,
                id: Date.now(),
                status: targetStatus || newClientForm.clientStatus || 'potential',
                employeeId: currentUser.id,
                logs: [{ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تسجيل جديد' }],
                measurements: { status: 'pending', date: '', files: [] },
                appointment: { date: '', time: '', status: 'pending' },
                design: { status: 'pending', total: 0, firstPayment: 0, signed: false },
                designImages: [],
                quotationItems: [],
                installation: { status: 'pending', jobNo: '', startDate: '', endDate: '', lastPayment: 0 },
                invoices: []
            };

            if(targetStatus === 'measurements') {
                client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تم التحويل لقسم القياسات' });
            }

            clients.unshift(client);
            
            newClientForm = { 
                code: generateCode(), 
                name: '', phone: '', whatsapp: '', email: '', address: '', location: '', 
                type: 'أفراد', source: 'social', taxId: '', clientStatus: 'potential',
                projectDetails: { kitchen: 0, bedroom: 0, cladding: 0, doors: 0, vanity: 0, tvUnit: 0 },
                customProjects: [],
                notes: '',
                measureRequest: { date: '', time: '', isPaid: false, amount: 0 }
            };
            
            saveClients();
            alert('تم الحفظ بنجاح');
        }

        function sendToMeasurements() {
            if(confirm('هل أنت متأكد من حفظ البيانات وإرسالها لقسم رفع المقاسات؟')) {
                saveNewClient('measurements');
            }
        }

        function notifyClient() {
            const phone = newClientForm.whatsapp || newClientForm.phone;
            if(!phone) return alert('يرجى إدخال رقم الجوال أو الواتساب أولاً');
            
            const msg = `مرحباً ${newClientForm.name}،\nسعدنا بتواصلك مع بيت الخزائن.\nتم تسجيل بياناتك بنجاح برقم ملف: ${newClientForm.code}\nسيقوم فريقنا بالتواصل معك قريباً.`;
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        function selectClientForMeasure(id) { selectedClientId = id; render(); }
        function selectClientForDesign(id) { selectedClientForDesignId = id; render(); }
        function selectClientForPricing(id) { selectedClientForPricingId = id; render(); }
        function selectClientForInstall(id) { selectedClientForInstallId = id; render(); }

        function saveAppointment() {
            if (!selectedClientId) return;
            const date = document.getElementById('measure-date').value;
            const time = document.getElementById('measure-time').value;
            if(!date || !time) return alert('يرجى تحديد التاريخ والوقت');
            
            const client = clients.find(c => c.id == selectedClientId);
            if(client) {
                client.appointment = { date, time, status: 'scheduled' };
                client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: `تم تحديد موعد قياس: ${date} ${time}` });
                saveClients();
                alert('تم حفظ الموعد بنجاح');
            }
        }

        function getMeasurementItems(client) {
            let items = [];
            if (client.customProjects && client.customProjects.length > 0) {
                client.customProjects.forEach((p, i) => items.push({ id: `custom-${i}`, label: `${p.name} (العدد: ${p.qty})` }));
            }
            
            const map = { kitchen: 'مطبخ', bedroom: 'غرفة نوم', cladding: 'تجليد', doors: 'أبواب', vanity: 'خزائن', tvUnit: 'وحدة TV' };
            if (client.projectDetails) {
                Object.entries(client.projectDetails).forEach(([key, count]) => {
                    if (count > 0) {
                        for(let i=1; i<=count; i++) items.push({ id: `${key}-${i}`, label: `${map[key] || key} ${count > 1 ? i : ''}` });
                    }
                });
            }
            return items;
        }

        function handleSaveMeasurements() {
            if (!selectedClientId) return;
            const client = clients.find(c => c.id == selectedClientId);
            if (client) {
                client.measurements.status = 'completed';
                client.measurements.date = new Date().toLocaleDateString('en-US');
                client.status = 'measurements';
                client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تم رفع المقاسات' });
                saveClients();
                render();
                alert('تم حفظ المقاسات وتحديث الحالة');
            }
        }

        function sendToDesign() {
            if (!selectedClientId) return;
            const client = clients.find(c => c.id == selectedClientId);
            if (client) {
                if(client.measurements.status !== 'completed') {
                    if(!confirm('لم يتم تأكيد رفع المقاسات بعد. هل تريد المتابعة؟')) return;
                }
                client.status = 'design';
                client.logs.push({ date: new Date().toLocaleDateString('en-US'), type: 'system', text: 'تم التحويل لقسم التصميم' });
                saveClients();
                render();
                alert('تم إرسال العميل لقسم التصميم');
            }
        }

        function notifyClientMeasurement() {
            if (!selectedClientId) return;
            const client = clients.find(c => c.id == selectedClientId);
            if(client) {
                let msg = `مرحباً ${client.name}،\n`;
                if(client.appointment && client.appointment.status === 'scheduled') {
                    msg += `تم تحديد موعد لرفع المقاسات بتاريخ ${client.appointment.date} الساعة ${client.appointment.time}.`;
                } else if (client.measurements.status === 'completed') {
                    msg += `تم الانتهاء من رفع المقاسات بنجاح، وجاري العمل على التصميم.`;
                } else {
                    msg += `نود إبلاغك بمستجدات مشروعك لدى بيت الخزائن.`;
                }
                const url = `https://wa.me/${client.phone}?text=${encodeURIComponent(msg)}`;
                window.open(url, '_blank');
            }
        }

        // Design Images Logic
        function handleDesignImageUpload(input) {
            if (!selectedClientForDesignId || !input.files || input.files.length === 0) return;
            const client = clients.find(c => c.id == selectedClientForDesignId);
            if (!client) return;

            if (!client.designImages) client.designImages = [];

            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    client.designImages.push(e.target.result);
                    saveClients();
                    render(); // Re-render to show images
                };
                reader.readAsDataURL(file);
            });
        }

        function deleteDesignImage(idx) {
            const client = clients.find(c => c.id == selectedClientForDesignId);
            if (client && client.designImages) {
                if(confirm('هل أنت متأكد من حذف هذه الصورة؟')) {
                    client.designImages.splice(idx, 1);
                    saveClients();
                    render();
                }
            }
        }

        // Pricing Logic
        function addPricingItem() {
            if(!selectedClientForPricingId) return;
            const client = clients.find(c => c.id == selectedClientForPricingId);
            if(!client.quotationItems) client.quotationItems = [];
            client.quotationItems.push({ name: '', qty: 1, price: 0 });
            render();
        }

        function removePricingItem(idx) {
            const client = clients.find(c => c.id == selectedClientForPricingId);
            client.quotationItems.splice(idx, 1);
            render();
        }

        function updatePricingItem(idx, field, value) {
            const client = clients.find(c => c.id == selectedClientForPricingId);
            client.quotationItems[idx][field] = field === 'name' ? value : parseFloat(value);
            // Re-render to update totals
            render();
        }

        function savePricingData() {
            if (!selectedClientForPricingId) return;
            const client = clients.find(c => c.id == selectedClientForPricingId);
            if (client) {
                const items = client.quotationItems || [];
                const total = items.reduce((sum, item) => sum + (item.qty * item.price), 0);
                const first = document.getElementById('pricing-first-payment').value;
                const signed = document.getElementById('signed-pricing').checked;

                client.design.total = total;
                client.design.firstPayment = first;
                client.design.signed = signed;
                
                if (signed) {
                    client.design.status = 'approved';
                    client.status = 'design';
                }
                saveClients();
                render();
                alert('تم حفظ عرض السعر بنجاح');
            }
        }

        function handleSaveInstallation() {
            if (!selectedClientForInstallId) return;
            const client = clients.find(c => c.id == selectedClientForInstallId);
            if (client) {
                client.installation.jobNo = document.getElementById('install-job').value;
                client.installation.startDate = document.getElementById('install-start').value;
                client.installation.lastPayment = document.getElementById('install-last-pay').value;
                client.status = 'installation';
                saveClients();
                alert('تم جدولة التركيب بنجاح');
            }
        }

        function openClientModal(id) {
            const client = clients.find(c => c.id === id);
            if(!client) return;
            const modal = document.getElementById('clientModal');
            
            // Prepare Project Details HTML
            let projectHtml = '';
            // Handle legacy projectDetails
            if(client.projectDetails && Object.values(client.projectDetails).some(v => v > 0)) {
                Object.entries(client.projectDetails).forEach(([k, v]) => {
                    if(v > 0) {
                        const label = k === 'kitchen' ? 'مطبخ' : k === 'bedroom' ? 'غرفة نوم' : k === 'cladding' ? 'تجليد' : k === 'doors' ? 'أبواب' : k === 'vanity' ? 'خزائن' : k === 'tvUnit' ? 'وحدة TV' : k;
                        projectHtml += `<span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-lg text-sm font-bold border border-blue-100">${label}: ${v}</span>`;
                    }
                });
            }
            // Handle customProjects
            if(client.customProjects && client.customProjects.length > 0) {
                client.customProjects.forEach(p => {
                    projectHtml += `<span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-lg text-sm font-bold border border-blue-100">${p.name}: ${p.qty}</span>`;
                });
            }
            if(!projectHtml) projectHtml = '<span class="text-slate-400 italic">لا توجد تفاصيل مسجلة</span>';

            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden animate-scaleIn max-h-[90vh] flex flex-col transition-colors">
                    <!-- Header -->
                    <div class="bg-[#0f3057] text-white p-6 flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <h2 class="text-2xl font-bold">${client.name}</h2>
                                <span class="bg-white/20 px-2 py-0.5 rounded text-xs font-mono">${client.code}</span>
                                <span class="bg-white/10 px-2 py-0.5 rounded text-xs">${getStatusLabel(client.status)}</span>
                            </div>
                            <div class="flex flex-wrap gap-4 text-sm text-blue-200">
                                <span class="flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${client.phone}</span>
                                ${client.email ? `<span class="flex items-center gap-1"><i data-lucide="mail" class="w-3 h-3"></i> ${client.email}</span>` : ''}
                            </div>
                        </div>
                        <button onclick="document.getElementById('clientModal').classList.add('hidden')" class="hover:bg-white/10 p-2 rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>

                    <!-- Body -->
                    <div class="p-6 overflow-y-auto custom-scrollbar space-y-8">
                        
                        <!-- Info Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">البيانات الأساسية</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between"><span class="text-slate-500">النوع:</span> <span class="font-medium dark:text-slate-200">${client.type}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-500">المصدر:</span> <span class="font-medium dark:text-slate-200">${client.source || '-'}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-500">الرقم الضريبي:</span> <span class="font-mono dark:text-slate-200">${client.taxId || '-'}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-500">العنوان:</span> <span class="font-medium dark:text-slate-200 truncate w-32 text-left" title="${client.address}">${client.address || '-'}</span></div>
                                    ${client.location ? `<div class="flex justify-between items-center"><span class="text-slate-500">الموقع:</span> <a href="${client.location}" target="_blank" class="text-blue-600 hover:underline flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> الخريطة</a></div>` : ''}
                                </div>
                            </div>

                            <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-700 md:col-span-2">
                                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">تفاصيل المشروع</h3>
                                <div class="flex flex-wrap gap-2 mb-4">
                                    ${projectHtml}
                                </div>
                                ${client.notes ? `
                                    <div class="pt-3 border-t border-slate-200 dark:border-slate-700">
                                        <p class="text-xs text-slate-400 mb-1">ملاحظات:</p>
                                        <p class="text-sm text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-800 p-2 rounded border border-slate-200 dark:border-slate-600">${client.notes}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Workflow Status -->
                        <div>
                            <h3 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><i data-lucide="git-commit" class="w-5 h-5 text-blue-500"></i> مسار العمل</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Measurements -->
                                <div class="border rounded-xl p-4 ${client.measurements.status === 'completed' ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'}">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-bold text-sm flex items-center gap-2 dark:text-slate-200">
                                            <i data-lucide="ruler" class="w-4 h-4"></i> المقاسات
                                        </span>
                                        ${client.measurements.status === 'completed' ? '<i data-lucide="check" class="w-4 h-4 text-green-600"></i>' : ''}
                                    </div>
                                    <p class="text-xs text-slate-500 mb-1">الحالة: <span class="font-bold dark:text-slate-300">${client.measurements.status === 'completed' ? 'مكتمل' : 'معلق'}</span></p>
                                    ${client.appointment && client.appointment.date ? `<p class="text-[10px] text-slate-400">موعد: ${client.appointment.date} ${client.appointment.time}</p>` : ''}
                                    ${client.measureRequest && client.measureRequest.date ? `
                                        <div class="mt-2 pt-2 border-t border-slate-100 dark:border-slate-700">
                                            <p class="text-[10px] font-bold text-slate-600">طلب العميل:</p>
                                            <p class="text-[10px] text-slate-500">${client.measureRequest.date} - ${client.measureRequest.time}</p>
                                            ${client.measureRequest.isPaid ? `<span class="text-[10px] text-green-600 font-bold">مدفوع (${client.measureRequest.amount})</span>` : '<span class="text-[10px] text-slate-400">غير مدفوع</span>'}
                                        </div>
                                    ` : ''}
                                </div>

                                <!-- Design -->
                                <div class="border rounded-xl p-4 ${client.design.signed ? 'bg-purple-50 dark:bg-purple-900/20 border-purple-200 dark:border-purple-800' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'}">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-bold text-sm flex items-center gap-2 dark:text-slate-200">
                                            <i data-lucide="pen-tool" class="w-4 h-4"></i> التصميم
                                        </span>
                                        ${client.design.signed ? '<i data-lucide="check" class="w-4 h-4 text-purple-600"></i>' : ''}
                                    </div>
                                    <p class="text-xs text-slate-500 mb-1">الحالة: <span class="font-bold dark:text-slate-300">${client.design.signed ? 'تم التعاقد' : 'جاري العمل'}</span></p>
                                    ${client.design.total > 0 ? `<p class="text-[10px] text-slate-400">العقد: ${parseInt(client.design.total).toLocaleString()} ريال</p>` : ''}
                                </div>

                                <!-- Installation -->
                                <div class="border rounded-xl p-4 ${client.installation.startDate ? 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'}">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-bold text-sm flex items-center gap-2 dark:text-slate-200">
                                            <i data-lucide="hammer" class="w-4 h-4"></i> التركيب
                                        </span>
                                    </div>
                                    <p class="text-xs text-slate-500 mb-1">الحالة: <span class="font-bold dark:text-slate-300">${client.installation.startDate ? 'مجدول' : 'لم يحدد'}</span></p>
                                    ${client.installation.startDate ? `<p class="text-[10px] text-slate-400">تاريخ: ${client.installation.startDate}</p>` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Logs -->
                        <div>
                            <h3 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><i data-lucide="history" class="w-5 h-5 text-slate-400"></i> سجل النشاطات</h3>
                            <div class="bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-100 dark:border-slate-700 p-4 max-h-48 overflow-y-auto custom-scrollbar space-y-3">
                                ${client.logs && client.logs.length > 0 ? client.logs.map(log => `
                                    <div class="flex gap-3 text-sm items-start">
                                        <span class="text-slate-400 text-[10px] font-mono whitespace-nowrap bg-white dark:bg-slate-800 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600 mt-0.5">${log.date}</span>
                                        <p class="text-slate-600 dark:text-slate-300 leading-tight">${log.text}</p>
                                    </div>
                                `).join('') : '<p class="text-slate-400 text-sm italic text-center">لا يوجد سجل نشاط</p>'}
                            </div>
                        </div>

                    </div>
                    
                    <!-- Footer -->
                    <div class="bg-slate-50 dark:bg-slate-900 p-4 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3">
                        <button onclick="document.getElementById('clientModal').classList.add('hidden')" class="px-6 py-2 bg-white border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition-colors font-bold text-sm">إغلاق</button>
                        <button onclick="openWhatsAppModal(${client.id})" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-bold text-sm flex items-center gap-2"><i data-lucide="message-circle" class="w-4 h-4"></i> مراسلة واتساب</button>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }
        
        function printInvoice(id) {
            const client = clients.find(c => c.id === id);
            if(!client) return;

            const printWindow = window.open('', '_blank');
            const logo = companySettings.logo ? `<img src="${companySettings.logo}" style="width: 80px; height: 80px; object-fit: contain;">` : `
                <svg viewBox="0 0 100 100" style="width: 80px; height: 80px;">
                    <path d="M 10,50 A 40,40 0 1,1 90,50" fill="none" stroke="#0f3057" stroke-width="8" stroke-linecap="round" />
                    <path d="M 90,50 A 40,40 0 1,1 10,50" fill="none" stroke="#f97316" stroke-width="8" stroke-linecap="round" />
                    <text x="50" y="72" font-family="Arial, sans-serif" font-weight="800" font-size="60" text-anchor="middle" fill="#0f3057">1</text>
                </svg>
            `;

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>عرض سعر - ${client.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0f3057; padding-bottom: 20px; margin-bottom: 40px; }
                        .company-info h1 { color: #0f3057; margin: 0 0 10px 0; font-size: 24px; }
                        .company-info p { margin: 2px 0; font-size: 13px; color: #64748b; }
                        .invoice-meta { display: flex; justify-content: space-between; margin-bottom: 30px; background: #f8fafc; padding: 20px; border-radius: 12px; }
                        .meta-item h3 { font-size: 12px; color: #64748b; margin: 0 0 5px 0; }
                        .meta-item p { font-size: 16px; font-weight: bold; color: #0f172a; margin: 0; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        th { background: #0f3057; color: white; padding: 12px; text-align: right; font-size: 14px; }
                        td { border-bottom: 1px solid #e2e8f0; padding: 12px; font-size: 14px; color: #334155; }
                        .total-section { background: #f8fafc; padding: 20px; border-radius: 12px; margin-left: auto; width: 300px; }
                        .total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
                        .total-row.final { border-top: 1px solid #e2e8f0; padding-top: 10px; font-weight: bold; font-size: 18px; color: #0f3057; }
                        .footer { margin-top: 60px; text-align: center; font-size: 12px; color: #94a3b8; border-top: 1px solid #e2e8f0; padding-top: 20px; }
                        @media print {
                            body { padding: 0; }
                            .no-print { display: none; }
                            th { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-info">
                            <h1>${companySettings.name}</h1>
                            <p>${companySettings.address}</p>
                            <p>هاتف: ${companySettings.phone}</p>
                            <p>البريد الإلكتروني: ${companySettings.email}</p>
                            <p>الرقم الضريبي: ${companySettings.taxId}</p>
                        </div>
                        <div>${logo}</div>
                    </div>

                    <div class="invoice-meta">
                        <div class="meta-item">
                            <h3>العميل</h3>
                            <p>${client.name}</p>
                            <p style="font-size: 12px; font-weight: normal; margin-top: 2px">${client.phone}</p>
                        </div>
                        <div class="meta-item">
                            <h3>رقم الملف</h3>
                            <p>${client.code}</p>
                        </div>
                        <div class="meta-item">
                            <h3>التاريخ</h3>
                            <p>${new Date().toLocaleDateString('en-US')}</p>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>الوصف</th>
                                <th width="150">القيمة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <strong>عرض سعر / عقد تنفيذ أعمال</strong><br>
                                    <span style="font-size: 12px; color: #64748b">
                                        يشمل: 
                                        ${Object.entries(client.projectDetails).filter(([k,v]) => v > 0).map(([k,v]) => `${k === 'kitchen' ? 'مطبخ' : k === 'bedroom' ? 'غرفة نوم' : k === 'cladding' ? 'تجليد' : k === 'doors' ? 'أبواب' : k === 'vanity' ? 'خزائن' : k === 'tvUnit' ? 'وحدة TV' : k} (${v})`).join('، ')}
                                        ${client.customProjects && client.customProjects.length ? '، ' + client.customProjects.map(p => `${p.name} (${p.qty})`).join('، ') : ''}
                                    </span>
                                </td>
                                <td>${parseInt(client.design.total).toLocaleString()} ريال</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="total-section">
                        <div class="total-row">
                            <span>الإجمالي</span>
                            <span>${parseInt(client.design.total).toLocaleString()} ريال</span>
                        </div>
                        <div class="total-row">
                            <span>الدفعة الأولى</span>
                            <span style="color: #16a34a">${parseInt(client.design.firstPayment).toLocaleString()} ريال</span>
                        </div>
                        <div class="total-row final">
                            <span>المتبقي</span>
                            <span>${(parseInt(client.design.total) - parseInt(client.design.firstPayment)).toLocaleString()} ريال</span>
                        </div>
                    </div>

                    <div class="footer">
                        <p>تم إصدار هذا المستند إلكترونياً من نظام إدارة العملاء CRP</p>
                        <p>العنوان: الرياض - طريق الملك فهد - برج العليا</p>
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function printReceipt(id) {
            const client = clients.find(c => c.id === id);
            if(!client) return;

            if(!client.design.firstPayment || client.design.firstPayment <= 0) {
                alert('لا توجد دفعة أولى مسجلة لهذا العميل لطباعة سند لها.');
                return;
            }

            const printWindow = window.open('', '_blank');
            const logo = companySettings.logo ? `<img src="${companySettings.logo}" style="width: 80px; height: 80px; object-fit: contain;">` : `
                <svg viewBox="0 0 100 100" style="width: 80px; height: 80px;">
                    <path d="M 10,50 A 40,40 0 1,1 90,50" fill="none" stroke="#0f3057" stroke-width="8" stroke-linecap="round" />
                    <path d="M 90,50 A 40,40 0 1,1 10,50" fill="none" stroke="#f97316" stroke-width="8" stroke-linecap="round" />
                    <text x="50" y="72" font-family="Arial, sans-serif" font-weight="800" font-size="60" text-anchor="middle" fill="#0f3057">1</text>
                </svg>
            `;

            // Prepare Project Details String
            const projectDetailsText = Object.entries(client.projectDetails)
                .filter(([k,v]) => v > 0)
                .map(([k,v]) => `${k === 'kitchen' ? 'مطبخ' : k === 'bedroom' ? 'غرفة نوم' : k === 'cladding' ? 'تجليد' : k === 'doors' ? 'أبواب' : k === 'vanity' ? 'خزائن' : k === 'tvUnit' ? 'وحدة TV' : k} (${v})`)
                .join('، ');
            
            const customDetailsText = client.customProjects && client.customProjects.length 
                ? client.customProjects.map(p => `${p.name} (${p.qty})`).join('، ') 
                : '';

            const fullDetails = [projectDetailsText, customDetailsText].filter(Boolean).join('، ');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>سند قبض - ${client.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; border: 1px solid #eee; }
                        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0f3057; padding-bottom: 20px; margin-bottom: 30px; }
                        .company-info h1 { color: #0f3057; margin: 0 0 5px 0; font-size: 22px; }
                        .company-info p { margin: 2px 0; font-size: 12px; color: #64748b; }
                        .receipt-title { text-align: center; margin-bottom: 30px; }
                        .receipt-title h2 { background: #f1f5f9; display: inline-block; padding: 10px 30px; border-radius: 20px; color: #0f3057; border: 1px solid #cbd5e1; }
                        .content { line-height: 2.5; font-size: 16px; color: #334155; }
                        .field { border-bottom: 1px dotted #94a3b8; padding: 0 10px; font-weight: bold; color: #0f172a; }
                        .amount-box { border: 2px solid #0f3057; padding: 15px; border-radius: 10px; text-align: center; margin: 20px 0; background: #f8fafc; }
                        .amount-box span { font-size: 24px; font-weight: bold; color: #0f3057; }
                        .signatures { display: flex; justify-content: space-between; margin-top: 60px; padding-top: 20px; }
                        .sig-block { text-align: center; width: 200px; }
                        .sig-line { border-top: 1px solid #cbd5e1; margin-top: 40px; }
                        @media print {
                            body { border: none; padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-info">
                            <h1>${companySettings.name}</h1>
                            <p>${companySettings.address}</p>
                            <p>هاتف: ${companySettings.phone}</p>
                        </div>
                        <div>${logo}</div>
                    </div>

                    <div class="receipt-title">
                        <h2>سند قبض | RECEIPT VOUCHER</h2>
                    </div>

                    <div class="content">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <div>التاريخ: <span class="field">${new Date().toLocaleDateString('en-US')}</span></div>
                            <div>رقم السند: <span class="field">RV-${client.code}-${Math.floor(Math.random() * 1000)}</span></div>
                        </div>

                        <div>استلمنا من السيد/السادة: <span class="field" style="display: inline-block; min-width: 300px;">${client.name}</span></div>
                        
                        <div class="amount-box">
                            مبلغ وقدره: <span>${parseInt(client.design.firstPayment).toLocaleString()} ريال سعودي</span>
                        </div>

                        <div>وذلك مقابل: <span class="field">دفعة أولى - عقد تنفيذ أعمال</span></div>
                        <div>تفاصيل المشروع: <span class="field" style="display: block; margin-top: 5px; line-height: 1.8;">${fullDetails}</span></div>
                    </div>

                    <div class="signatures">
                        <div class="sig-block">
                            <p>المحاسب</p>
                            <div class="sig-line"></div>
                        </div>
                        <div class="sig-block">
                            <p>المستلم</p>
                            <div class="sig-line"></div>
                        </div>
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function openWhatsAppModal(id) {
             const c = clients.find(x => x.id === id);
             if(!c) return;
             const phone = c.whatsapp || c.phone;
             const url = `https://wa.me/${phone}`;
             window.open(url, '_blank');
        }

        function printDetailedQuotation(id) {
            const client = clients.find(c => c.id === id);
            if(!client) return;

            const items = client.quotationItems || [];
            const total = items.reduce((sum, item) => sum + (item.qty * item.price), 0);

            const printWindow = window.open('', '_blank');
            const logo = companySettings.logo ? `<img src="${companySettings.logo}" style="width: 80px; height: 80px; object-fit: contain;">` : `
                <svg viewBox="0 0 100 100" style="width: 80px; height: 80px;">
                    <path d="M 10,50 A 40,40 0 1,1 90,50" fill="none" stroke="#0f3057" stroke-width="8" stroke-linecap="round" />
                    <path d="M 90,50 A 40,40 0 1,1 10,50" fill="none" stroke="#f97316" stroke-width="8" stroke-linecap="round" />
                    <text x="50" y="72" font-family="Arial, sans-serif" font-weight="800" font-size="60" text-anchor="middle" fill="#0f3057">1</text>
                </svg>
            `;

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>عرض سعر تفصيلي - ${client.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0f3057; padding-bottom: 20px; margin-bottom: 40px; }
                        .company-info h1 { color: #0f3057; margin: 0 0 10px 0; font-size: 24px; }
                        .company-info p { margin: 2px 0; font-size: 13px; color: #64748b; }
                        .invoice-meta { display: flex; justify-content: space-between; margin-bottom: 30px; background: #f8fafc; padding: 20px; border-radius: 12px; }
                        .meta-item h3 { font-size: 12px; color: #64748b; margin: 0 0 5px 0; }
                        .meta-item p { font-size: 16px; font-weight: bold; color: #0f172a; margin: 0; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        th { background: #0f3057; color: white; padding: 12px; text-align: right; font-size: 14px; }
                        td { border-bottom: 1px solid #e2e8f0; padding: 12px; font-size: 14px; color: #334155; }
                        .text-center { text-align: center; }
                        .total-section { background: #f8fafc; padding: 20px; border-radius: 12px; margin-left: auto; width: 300px; }
                        .total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
                        .total-row.final { border-top: 1px solid #e2e8f0; padding-top: 10px; font-weight: bold; font-size: 18px; color: #0f3057; }
                        .footer { margin-top: 60px; text-align: center; font-size: 12px; color: #94a3b8; border-top: 1px solid #e2e8f0; padding-top: 20px; }
                        @media print {
                            body { padding: 0; }
                            th { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-info">
                            <h1>${companySettings.name}</h1>
                            <p>${companySettings.address}</p>
                            <p>هاتف: ${companySettings.phone}</p>
                            <p>البريد الإلكتروني: ${companySettings.email}</p>
                            <p>الرقم الضريبي: ${companySettings.taxId}</p>
                        </div>
                        <div>${logo}</div>
                    </div>

                    <div class="invoice-meta">
                        <div class="meta-item">
                            <h3>العميل</h3>
                            <p>${client.name}</p>
                            <p style="font-size: 12px; font-weight: normal; margin-top: 2px">${client.phone}</p>
                        </div>
                        <div class="meta-item">
                            <h3>رقم العرض</h3>
                            <p>QT-${client.code}</p>
                        </div>
                        <div class="meta-item">
                            <h3>التاريخ</h3>
                            <p>${new Date().toLocaleDateString('en-US')}</p>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th width="50" class="text-center">#</th>
                                <th>البند / الوصف</th>
                                <th width="80" class="text-center">الكمية</th>
                                <th width="120">السعر الإفرادي</th>
                                <th width="120">الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map((item, idx) => `
                                <tr>
                                    <td class="text-center">${idx + 1}</td>
                                    <td>${item.name}</td>
                                    <td class="text-center">${item.qty}</td>
                                    <td>${item.price.toLocaleString()}</td>
                                    <td>${(item.qty * item.price).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="total-section">
                        <div class="total-row final">
                            <span>المجموع الكلي</span>
                            <span>${total.toLocaleString()} ريال</span>
                        </div>
                        <div class="total-row" style="margin-top: 10px; font-size: 12px; color: #64748b;">
                            <span>الأسعار تشمل ضريبة القيمة المضافة</span>
                        </div>
                    </div>

                    <div class="footer">
                        <p>تم إصدار هذا العرض إلكترونياً من نظام إدارة العملاء CRP</p>
                        <p>صلاحية العرض 15 يوماً من تاريخه</p>
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        init();
    </script>
</body>
</html>
