<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة العملاء - IN ONE OPERATION</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Cairo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f5f9;
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .active-nav-item {
            background-color: #1a4b82;
            color: white;
            border-right: 4px solid #e5b57f;
        }
        .inactive-nav-item {
            color: #dbeafe; /* blue-100 */
            border-right: 4px solid transparent;
        }
        .inactive-nav-item:hover {
            background-color: #0a2342;
            color: white;
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebar" class="bg-[#0f3057] text-white w-64 flex-shrink-0 flex flex-col transition-all duration-300 shadow-xl z-20 h-full md:relative absolute transform -translate-x-full md:translate-x-0">
        <div class="p-6 flex flex-col items-center border-b border-blue-900/50">
            <!-- New Logo Implementation -->
            <div class="w-20 h-20 mb-3 bg-[#fdf6e7] rounded-full flex items-center justify-center shadow-lg relative overflow-hidden">
                <!-- SVG Logo based on description (Circle with blue top, orange bottom, and number 1) -->
                <svg viewBox="0 0 100 100" class="w-full h-full">
                    <!-- Top Half Circle Stroke (Blue) -->
                    <path d="M 10,50 A 40,40 0 1,1 90,50" fill="none" stroke="#0f3057" stroke-width="8" />
                    <!-- Bottom Half Circle Stroke (Orange) -->
                    <path d="M 90,50 A 40,40 0 1,1 10,50" fill="none" stroke="#f97316" stroke-width="8" />
                    <!-- Number 1 -->
                    <text x="50" y="75" font-family="Arial, sans-serif" font-weight="bold" font-size="65" text-anchor="middle" fill="#0f3057">1</text>
                </svg>
            </div>
            <h1 class="text-lg font-bold tracking-wider text-center" style="font-family: Arial, sans-serif;">IN ONE OPERATION</h1>
            <p class="text-xs text-blue-300 mt-1">Management System</p>
        </div>

        <nav class="flex-1 px-3 space-y-1 mt-6 overflow-y-auto custom-scrollbar">
            <button class="w-full flex items-center gap-3 px-4 py-3 my-1 rounded-r-lg transition-all duration-200 inactive-nav-item">
                <i data-lucide="users" class="w-4 h-4 opacity-70"></i>
                <span class="font-medium text-sm tracking-wide">المستخدمين</span>
            </button>
            <button class="w-full flex items-center gap-3 px-4 py-3 my-1 rounded-r-lg transition-all duration-200 inactive-nav-item">
                <i data-lucide="shield" class="w-4 h-4 opacity-70"></i>
                <span class="font-medium text-sm tracking-wide">الصلاحيات</span>
            </button>
            
            <div class="my-2 border-t border-blue-800/50"></div>
            
            <button onclick="switchTab('registration')" id="nav-registration" class="w-full flex items-center gap-3 px-4 py-3 my-1 rounded-r-lg transition-all duration-200 active-nav-item">
                <i data-lucide="user-check" class="w-4 h-4"></i>
                <span class="font-medium text-sm tracking-wide">تسجيل العملاء</span>
            </button>
            <button onclick="switchTab('measurements')" id="nav-measurements" class="w-full flex items-center gap-3 px-4 py-3 my-1 rounded-r-lg transition-all duration-200 inactive-nav-item">
                <i data-lucide="ruler" class="w-4 h-4 opacity-70"></i>
                <span class="font-medium text-sm tracking-wide">أخذ المقاسات</span>
            </button>
            <button onclick="switchTab('design')" id="nav-design" class="w-full flex items-center gap-3 px-4 py-3 my-1 rounded-r-lg transition-all duration-200 inactive-nav-item">
                <i data-lucide="pen-tool" class="w-4 h-4 opacity-70"></i>
                <span class="font-medium text-sm tracking-wide">التصميم والتسعير</span>
            </button>
            <button onclick="switchTab('installation')" id="nav-installation" class="w-full flex items-center gap-3 px-4 py-3 my-1 rounded-r-lg transition-all duration-200 inactive-nav-item">
                <i data-lucide="hammer" class="w-4 h-4 opacity-70"></i>
                <span class="font-medium text-sm tracking-wide">مرحلة التركيب</span>
            </button>

            <div class="my-2 border-t border-blue-800/50"></div>
            
            <button class="w-full flex items-center gap-3 px-4 py-3 my-1 rounded-r-lg transition-all duration-200 inactive-nav-item">
                <i data-lucide="file-text" class="w-4 h-4 opacity-70"></i>
                <span class="font-medium text-sm tracking-wide">العروض</span>
            </button>
            <button class="w-full flex items-center gap-3 px-4 py-3 my-1 rounded-r-lg transition-all duration-200 inactive-nav-item">
                <i data-lucide="layout-dashboard" class="w-4 h-4 opacity-70"></i>
                <span class="font-medium text-sm tracking-wide">التقارير</span>
            </button>
        </nav>

        <div class="p-4 bg-[#0a2342] mt-auto">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold border-2 border-white/20">
                    خ
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium truncate">خالد رمزي</p>
                    <p class="text-xs text-blue-300 truncate">مهندس تصميم</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-10 hidden md:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden relative w-full">
        <!-- Header -->
        <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 z-10 sticky top-0">
            <div class="flex items-center gap-4 flex-1">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-600 p-1 rounded hover:bg-gray-100">
                    <i data-lucide="menu"></i>
                </button>
                <div class="relative w-full max-w-md hidden md:block">
                    <i data-lucide="search" class="absolute right-3 top-2.5 h-5 w-5 text-gray-300"></i>
                    <input type="text" placeholder="بحث سريع (الاسم، الهاتف، الكود)..." 
                        class="w-full pr-10 pl-4 py-2 bg-gray-50 border border-transparent focus:bg-white focus:border-blue-500 rounded-full text-sm transition-all outline-none">
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="resetData()" class="text-red-500 text-xs hover:underline hidden md:block">إعادة تعيين البيانات</button>
                <button class="hidden md:flex items-center gap-2 text-xs px-3 py-1.5 h-8 bg-[#0f3057] text-white rounded-lg hover:bg-[#1a4b82] transition shadow-sm">
                    <i data-lucide="plus" class="w-4 h-4"></i> جديد
                </button>
                <button class="relative p-2 text-gray-500 hover:bg-gray-100 rounded-full transition-colors">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-1.5 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                </button>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 animate-fadeIn">
            <!-- Content will be injected via JS -->
        </div>
    </main>

    <!-- JavaScript Application Logic -->
    <script>
        // --- Data & Constants ---
        const INITIAL_CLIENTS = [
            { 
                id: 1, code: 'BK-5464', name: 'أحمد محمد', phone: '0501234567', 
                email: 'ahmed@email.com', address: 'الرياض - حي العليا', 
                source: 'social', status: 'potential', budget: 25000, taxNo: '300012345600003',
                projectDetails: { kitchen: 1, bedroom: 2, cladding: 0, doors: 5, vanity: 2, tvUnit: 1 },
                notes: 'يفضل الألوان الفاتحة',
                measurements: { status: 'pending', date: '2025-02-20' },
                design: { status: 'pending', total: 0, firstPayment: 0 },
                installation: { status: 'pending', jobNo: 'J-0123', startDate: '', endDate: '' }
            },
            { 
                id: 2, code: 'LD-9383', name: 'سارة علي', phone: '0559876543', 
                email: 'sara@email.com', address: 'جدة - الروضة', 
                source: 'referral', status: 'design', budget: 45000, taxNo: '',
                projectDetails: { kitchen: 1, bedroom: 3, cladding: 10, doors: 0, vanity: 3, tvUnit: 1 },
                notes: '',
                measurements: { status: 'completed', date: '2025-02-15' },
                design: { status: 'waiting_approval', total: 55000, firstPayment: 20000 },
                installation: { status: 'pending', jobNo: 'J-0124', startDate: '', endDate: '' }
            }
        ];

        const STATUS_OPTIONS = [
            { id: 'new', label: 'عميل جديد', color: 'bg-blue-100 text-blue-800' },
            { id: 'potential', label: 'محتمل', color: 'bg-yellow-100 text-yellow-800' },
            { id: 'measurements', label: 'جاري القياس', color: 'bg-purple-100 text-purple-800' },
            { id: 'design', label: 'مرحلة التصميم', color: 'bg-indigo-100 text-indigo-800' },
            { id: 'installation', label: 'مرحلة التركيب', color: 'bg-orange-100 text-orange-800' },
            { id: 'completed', label: 'مكتمل', color: 'bg-green-100 text-green-800' },
        ];

        // --- State Management ---
        let clients = [];
        let activeTab = 'registration';
        
        // Form States
        let newClientForm = {
            code: generateCode(),
            name: '', phone: '', address: '',
            projectDetails: { kitchen: 0, bedroom: 0, cladding: 0, doors: 0, vanity: 0, tvUnit: 0 }
        };

        // --- Initialization ---
        function init() {
            loadClients();
            render();
        }

        function loadClients() {
            const saved = localStorage.getItem('crm_clients_data');
            if (saved) {
                try {
                    clients = JSON.parse(saved);
                } catch (e) {
                    clients = INITIAL_CLIENTS;
                }
            } else {
                clients = INITIAL_CLIENTS;
            }
        }

        function saveClients() {
            localStorage.setItem('crm_clients_data', JSON.stringify(clients));
            render(); // Re-render to update tables/stats
        }

        function generateCode() {
            return 'BK-' + Math.floor(1000 + Math.random() * 9000);
        }

        function resetData() {
            if(confirm('هل أنت متأكد من حذف جميع البيانات واستعادة الافتراضية؟')) {
                clients = INITIAL_CLIENTS;
                saveClients();
                location.reload();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                // Open
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                // Close
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function switchTab(tabName) {
            activeTab = tabName;
            
            // Update Sidebar UI
            document.querySelectorAll('nav button[id^="nav-"]').forEach(btn => {
                btn.classList.remove('active-nav-item');
                btn.classList.add('inactive-nav-item');
                // fix icon colors manually since classes changed
                const icon = btn.querySelector('i');
                if(icon) icon.classList.add('opacity-70');
            });

            const activeBtn = document.getElementById(`nav-${tabName}`);
            if (activeBtn) {
                activeBtn.classList.remove('inactive-nav-item');
                activeBtn.classList.add('active-nav-item');
                activeBtn.querySelector('i').classList.remove('opacity-70');
            }

            // Close sidebar on mobile after selection
            if(window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                if (!sidebar.classList.contains('-translate-x-full')) toggleSidebar();
            }

            render();
        }

        // --- Render Views ---

        function render() {
            const container = document.getElementById('content-area');
            container.innerHTML = ''; // Clear content

            if (activeTab === 'registration') container.innerHTML = renderRegistrationView();
            else if (activeTab === 'measurements') container.innerHTML = renderMeasurementsView();
            else if (activeTab === 'design') container.innerHTML = renderDesignView();
            else if (activeTab === 'installation') container.innerHTML = renderInstallationView();

            lucide.createIcons(); // Refresh icons
            
            // Re-attach listeners for inputs since innerHTML wiped them
            attachEventListeners();
        }

        // 1. Registration View
        function renderRegistrationView() {
            return `
                <div class="space-y-6">
                    <!-- Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        ${renderStatCard('إجمالي العملاء', clients.length, 'users', 'text-blue-600 bg-blue-100')}
                        ${renderStatCard('مشاريع نشطة', '5', 'briefcase', 'text-yellow-600 bg-yellow-100')}
                        ${renderStatCard('مشاريع مكتملة', '12', 'check-circle', 'text-green-600 bg-green-100')}
                        ${renderStatCard('عملاء محتملون', '3', 'user-check', 'text-red-600 bg-red-100')}
                    </div>

                    <!-- Filter Bar -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex items-center gap-2 text-gray-500">
                            <i data-lucide="filter" class="w-5 h-5"></i>
                            <span class="font-medium">تصفية القائمة:</span>
                        </div>
                        <div class="flex gap-4 flex-1 max-w-2xl">
                            <select class="flex-1 bg-gray-50 border-gray-200 rounded-lg text-sm p-2.5 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                <option>جميع الحالات</option>
                                ${STATUS_OPTIONS.map(s => `<option value="${s.id}">${s.label}</option>`).join('')}
                            </select>
                            <select class="flex-1 bg-gray-50 border-gray-200 rounded-lg text-sm p-2.5 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                <option>جميع المصادر</option>
                                <option>معرض</option>
                                <option>سوشيال ميديا</option>
                            </select>
                        </div>
                    </div>

                    <!-- Add Form -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 border-t-4 border-t-blue-500">
                        <div class="mb-6 border-b border-gray-100 pb-4">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <span class="w-1 h-6 bg-blue-600 rounded-full inline-block"></span>
                                بيانات العميل الجديد
                            </h2>
                            <p class="text-sm text-gray-500 mt-1 mr-3">أدخل المعلومات الأساسية وتفاصيل المشروع</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-700">كود العميل</label>
                                <input type="text" value="${newClientForm.code}" readonly class="w-full bg-gray-100 border-gray-200 rounded-lg p-2.5 text-gray-500 text-center font-mono">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-700">الاسم الكامل <span class="text-red-500">*</span></label>
                                <input type="text" id="input-name" value="${newClientForm.name}" class="w-full border-gray-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-700">رقم الجوال <span class="text-red-500">*</span></label>
                                <input type="text" id="input-phone" value="${newClientForm.phone}" placeholder="05xxxxxxxx" class="w-full border-gray-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none text-left dir-ltr">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-700">العنوان</label>
                                <input type="text" id="input-address" value="${newClientForm.address}" class="w-full border-gray-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>

                        <div class="bg-gray-50/50 p-4 rounded-xl border border-dashed border-gray-200 mb-6">
                            <label class="text-xs font-bold text-blue-600 mb-3 block">تفاصيل المشاريع المطلوبة:</label>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                                ${renderCounter('مطبخ', 'kitchen')}
                                ${renderCounter('نوم', 'bedroom')}
                                ${renderCounter('تجليد', 'cladding')}
                                ${renderCounter('وحدة TV', 'tvUnit')}
                                ${renderCounter('أبواب', 'doors')}
                                ${renderCounter('مغاسل', 'vanity')}
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="handleSaveClient()" class="inline-flex items-center justify-center px-4 py-2.5 rounded-lg text-sm font-medium bg-[#0f3057] text-white hover:bg-[#1a4b82] hover:shadow-md transition">
                                <i data-lucide="save" class="w-4 h-4 ml-2"></i> حفظ البيانات
                            </button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h3 class="font-bold text-gray-700">سجل العملاء</h3>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">${clients.length} عميل</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-white text-gray-500 border-b border-gray-100">
                                    <tr>
                                        <th class="py-3 px-4 font-medium">الكود</th>
                                        <th class="py-3 px-4 font-medium">بيانات العميل</th>
                                        <th class="py-3 px-4 font-medium">المشاريع</th>
                                        <th class="py-3 px-4 font-medium">المصدر</th>
                                        <th class="py-3 px-4 font-medium">الحالة</th>
                                        <th class="py-3 px-4 font-medium text-center">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50">
                                    ${clients.map(client => `
                                        <tr class="hover:bg-blue-50/20 transition-colors">
                                            <td class="py-3 px-4 font-mono text-blue-600 font-semibold">${client.code}</td>
                                            <td class="py-3 px-4">
                                                <p class="font-bold text-gray-800">${client.name}</p>
                                                <p class="text-xs text-gray-500">${client.phone}</p>
                                            </td>
                                            <td class="py-3 px-4">
                                                <div class="flex gap-1 flex-wrap">
                                                    ${Object.entries(client.projectDetails).map(([k, v]) => v > 0 ? 
                                                        `<span class="text-[10px] bg-gray-100 border border-gray-200 px-1.5 py-0.5 rounded">${k === 'kitchen' ? 'مطبخ' : k === 'bedroom' ? 'غرفة' : k} (${v})</span>` 
                                                        : '').join('')}
                                                </div>
                                            </td>
                                            <td class="py-3 px-4 text-gray-600">${client.source === 'social' ? 'سوشيال' : 'إحالة'}</td>
                                            <td class="py-3 px-4">
                                                <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(client.status)}">
                                                    ${getStatusLabel(client.status)}
                                                </span>
                                            </td>
                                            <td class="py-3 px-4 flex justify-center gap-2">
                                                <button class="p-1 text-blue-600 hover:bg-blue-50 rounded"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                                <button onclick="handleDeleteClient(${client.id})" class="p-1 text-red-600 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // 2. Measurements View
        function renderMeasurementsView() {
            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${renderStatCard('إجمالي الملفات', '156', 'file-text', 'text-indigo-600 bg-indigo-100')}
                        ${renderStatCard('ملفات هذا الشهر', '24', 'calendar', 'text-purple-600 bg-purple-100')}
                        ${renderStatCard('صور وفيديوهات', '890', 'image', 'text-pink-600 bg-pink-100')}
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 border-t-4 border-t-indigo-500">
                        <div class="mb-6 border-b border-gray-100 pb-4">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <span class="w-1 h-6 bg-blue-600 rounded-full inline-block"></span>
                                تفاصيل المشروع والمقاسات
                            </h2>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-700">اسم العميل</label>
                                <select class="w-full border-gray-200 rounded-lg p-2.5 bg-white focus:ring-indigo-500 outline-none">
                                    <option value="">اختر عميل...</option>
                                    ${clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <!-- More read-only fields -->
                        </div>

                        <div class="space-y-4 mb-6">
                            <label class="text-sm font-bold text-gray-700 block">ملفات الميديا (فيديو / كروكي / صور):</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${renderUploadZone('video', 'رفع فيديو للموقع', 'MP4, MOV up to 50MB', 'bg-blue-50 border-blue-200 text-blue-500')}
                                ${renderUploadZone('pen-tool', 'رفع كروكي القياسات', 'PDF, PNG, JPG', 'bg-purple-50 border-purple-200 text-purple-500')}
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button class="inline-flex items-center justify-center px-4 py-2.5 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700">
                                <i data-lucide="save" class="w-4 h-4 ml-2"></i> حفظ الملفات
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 3. Design View (Implemented)
        function renderDesignView() {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-140px)]">
                    <!-- Left Column: Pricing & Contract -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 border-t-4 border-t-purple-500 h-full overflow-y-auto custom-scrollbar">
                            <div class="mb-6 border-b border-gray-100 pb-4">
                                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <span class="w-1 h-6 bg-purple-600 rounded-full inline-block"></span>
                                    التسعير والعقد
                                </h2>
                                <p class="text-sm text-gray-500 mt-1 mr-3">إصدار الكوتيشن، ومتابعة الموافقات</p>
                            </div>
                            
                            <div class="space-y-6">
                                <div class="bg-purple-50 p-6 rounded-xl border border-purple-100">
                                    <div class="space-y-4">
                                        <div class="space-y-1">
                                            <label class="text-sm font-bold text-gray-700">قيمة الكوتيشن الإجمالية (ريال سعودي)</label>
                                            <input type="number" placeholder="مثال: 55000" class="w-full text-lg font-bold text-purple-700 border-gray-300 rounded-lg p-3 focus:ring-purple-500 outline-none">
                                        </div>
                                        <div class="space-y-1">
                                            <label class="text-sm font-bold text-gray-700">قيمة الدفعة الأولى (ريال سعودي)</label>
                                            <input type="number" placeholder="مثال: 20000" class="w-full border-gray-300 rounded-lg p-3 outline-none">
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="text-sm font-bold text-gray-700">ارفاق صورة الكوتيشن الموقع</label>
                                    <div class="h-32 bg-gray-50 border-2 border-dashed rounded-lg flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:bg-gray-100 transition">
                                        <i data-lucide="upload" class="w-8 h-8 mb-2 opacity-50"></i>
                                        <span class="text-sm">اضغط لرفع الملف</span>
                                    </div>
                                </div>

                                <div class="pt-6 border-t">
                                    <div class="space-y-4">
                                        <div class="space-y-1">
                                            <label class="text-sm font-bold text-gray-700">حالة الموافقة على التصميم</label>
                                            <select class="w-full border-gray-300 rounded-lg p-3 outline-none bg-white">
                                                <option>بانتظار موافقة العميل</option>
                                                <option>تم الاعتماد</option>
                                                <option>مرفوض / تعديل</option>
                                            </select>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" id="signed" class="w-4 h-4 text-purple-600 rounded">
                                            <label for="signed" class="font-bold text-gray-700 select-none cursor-pointer">تأكيد توقيع العميل على العقد</label>
                                        </div>
                                    </div>
                                    
                                    <div class="flex gap-3 mt-6">
                                        <button class="flex-1 bg-purple-600 text-white hover:bg-purple-700 py-3 rounded-lg font-bold transition shadow-sm">حفظ وإصدار العقد</button>
                                        <button class="px-6 border border-gray-200 hover:bg-gray-50 rounded-lg text-gray-600 font-medium transition">إعادة تعيين</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Preview & Comments -->
                    <div class="lg:col-span-1 space-y-4">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 h-full flex flex-col">
                            <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">معاينة التصميم</h3>
                            
                            <div class="flex-1 bg-gray-100 rounded-lg border flex items-center justify-center text-gray-400 mb-4 min-h-[200px]">
                                <div class="text-center">
                                    <i data-lucide="image" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                    <span>لا يوجد تصميم مرفوع</span>
                                </div>
                            </div>

                            <div class="space-y-2 mb-4">
                                <label class="text-sm font-bold text-gray-700">تعليمات للعميل / ملاحظات</label>
                                <textarea placeholder="ملاحظات حول التصميم..." class="w-full border-gray-200 rounded-lg p-3 h-32 resize-none text-sm outline-none focus:border-purple-500"></textarea>
                            </div>

                            <div class="flex gap-2 mt-auto">
                                <button class="w-full bg-blue-500 text-white hover:bg-blue-600 py-2 rounded-lg flex items-center justify-center gap-2 transition">
                                    <i data-lucide="send" class="w-4 h-4"></i> إرسال للمراجعة
                                </button>
                                <button class="px-4 border border-gray-200 hover:bg-gray-50 rounded-lg text-gray-600">تفريغ</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 4. Installation View (Implemented)
        function renderInstallationView() {
            return `
                <div class="space-y-6 animate-fadeIn">
                    <!-- Installation Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        ${renderStatCard('إجمالي التركيبات', '45', 'hammer', 'text-orange-600 bg-orange-100')}
                        ${renderStatCard('جاري التركيب', '8', 'clock', 'text-yellow-600 bg-yellow-100')}
                        ${renderStatCard('مكتملة', '32', 'check-circle', 'text-green-600 bg-green-100')}
                        ${renderStatCard('متأخرة', '2', 'x-circle', 'text-red-600 bg-red-100')}
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left: Uploads -->
                        <div class="lg:col-span-1 space-y-6">
                           <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                             <h4 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                               <i data-lucide="image" class="w-5 h-5 text-green-600"></i> صور وفيديو ما بعد التركيب
                             </h4>
                             ${renderUploadZone('upload', 'اسحب الملفات هنا', 'أو انقر للاختيار', 'bg-green-50 border-green-200 text-green-500')}
                             <button class="w-full mt-4 bg-blue-500 text-white hover:bg-blue-600 py-2 rounded-lg flex items-center justify-center gap-2 transition">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> تأكيد الاستلام
                             </button>
                           </div>

                           <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                             <h4 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                               <i data-lucide="file-check" class="w-5 h-5 text-purple-600"></i> إرفاق إثبات التسليم
                             </h4>
                             ${renderUploadZone('file-text', 'اسحب صورة الإثبات', 'PDF, JPG', 'bg-purple-50 border-purple-200 text-purple-500')}
                             <button class="w-full mt-4 bg-purple-600 text-white hover:bg-purple-700 py-2 rounded-lg flex items-center justify-center gap-2 transition">
                                <i data-lucide="save" class="w-4 h-4"></i> حفظ
                             </button>
                           </div>
                        </div>

                        <!-- Right: Project Details Form -->
                        <div class="lg:col-span-2">
                          <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 border-t-4 border-t-orange-500">
                            <div class="flex justify-between items-center mb-6">
                              <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                                <i data-lucide="edit" class="w-5 h-5 text-orange-500"></i> تفاصيل المشروع
                              </h3>
                              <div class="flex gap-2">
                                <button class="bg-blue-500 text-white text-xs px-3 py-1.5 rounded hover:bg-blue-600 transition">+ جدولة تركيب جديدة</button>
                                <button class="p-2 border rounded-lg hover:bg-gray-50"><i data-lucide="calendar" class="w-4 h-4"></i></button>
                              </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                              <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-600">رقم الوظيفة</label>
                                <input type="text" placeholder="مثال: J-0123" class="w-full border-gray-200 rounded-lg p-2.5 bg-gray-50 text-right font-mono outline-none">
                              </div>
                              <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-600">اسم العميل</label>
                                <input type="text" placeholder="مثال: أحمد محمد" class="w-full border-gray-200 rounded-lg p-2.5 outline-none">
                              </div>
                              
                              <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-600">تاريخ بدء التركيب</label>
                                <input type="date" class="w-full border-gray-200 rounded-lg p-2.5 outline-none">
                              </div>
                              <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-600">تاريخ الانتهاء المتوقع</label>
                                <input type="date" class="w-full border-gray-200 rounded-lg p-2.5 outline-none">
                              </div>
                              
                              <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-600">تاريخ الاستلام الفعلي</label>
                                <input type="date" class="w-full border-gray-200 rounded-lg p-2.5 outline-none">
                              </div>
                              <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-600">حالة العمل</label>
                                <select class="w-full border-gray-200 rounded-lg p-2.5 bg-white outline-none">
                                   <option>قيد التنفيذ</option>
                                   <option>معلق</option>
                                   <option>مكتمل</option>
                                </select>
                              </div>

                              <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-600">الدفعة الأولى (ريال)</label>
                                <input type="number" placeholder="2000" class="w-full border-gray-200 rounded-lg p-2.5 outline-none">
                              </div>
                              <div class="space-y-1">
                                <label class="text-xs font-bold text-gray-600">الدفعة الأخيرة (ريال)</label>
                                <input type="number" placeholder="10000" class="w-full border-gray-200 rounded-lg p-2.5 outline-none">
                              </div>
                            </div>

                            <div class="mt-6 bg-orange-50 border border-orange-200 p-4 rounded-lg flex gap-3 items-start">
                              <i data-lucide="clock" class="w-5 h-5 text-orange-500 mt-0.5"></i>
                              <div>
                                <h5 class="font-bold text-orange-800 text-sm">ملاحظة المهلة</h5>
                                <p class="text-xs text-orange-700 mt-1">مهلة الاستلام 45 يوماً. في حال مرور 30 يوماً دون استلام، يجب سداد باقي قيمة المشروع المنفذ.</p>
                              </div>
                            </div>

                            <div class="mt-6 flex gap-3 justify-end">
                               <button class="px-4 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 flex items-center gap-2">
                                   <i data-lucide="refresh-cw" class="w-4 h-4"></i> إعادة تعيين
                               </button>
                               <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                   <i data-lucide="save" class="w-4 h-4"></i> تحديث
                               </button>
                            </div>
                          </div>
                        </div>
                    </div>
                    
                    <!-- History Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mt-6">
                        <div class="p-4 bg-gray-50 border-b border-gray-100 font-bold text-gray-700 flex items-center gap-2">
                          <i data-lucide="layout-dashboard" class="w-4 h-4"></i> تاريخ التركيبات
                        </div>
                        <div class="p-8 text-center text-gray-400">لا توجد بيانات تركيبات سابقة</div>
                    </div>
                </div>
            `;
        }

        // --- Helper Renderers ---

        function renderStatCard(title, value, icon, colorClass) {
            // colorClass e.g. "text-blue-600 bg-blue-100"
            const [textCol, bgCol] = colorClass.split(' ');
            return `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 flex flex-col justify-between h-32 relative overflow-hidden group hover:shadow-md transition-all">
                    <div class="flex justify-between items-start z-10">
                        <div>
                            <p class="text-gray-500 text-sm font-medium mb-1">${title}</p>
                            <h3 class="text-3xl font-bold text-gray-800">${value}</h3>
                        </div>
                        <div class="p-2 rounded-lg ${bgCol} bg-opacity-10">
                            <i data-lucide="${icon}" class="${textCol.replace('bg-', 'text-')} w-6 h-6"></i>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCounter(label, key) {
            return `
                <div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg border border-gray-200">
                    <span class="text-sm font-medium text-gray-600 px-2">${label}</span>
                    <div class="flex items-center bg-white rounded shadow-sm">
                        <button onclick="updateCounter('${key}', -1)" class="px-2 py-1 text-gray-500 hover:text-red-500 hover:bg-red-50 rounded-r">-</button>
                        <span id="count-${key}" class="w-8 text-center text-sm font-bold border-x border-gray-100 py-1">${newClientForm.projectDetails[key]}</span>
                        <button onclick="updateCounter('${key}', 1)" class="px-2 py-1 text-gray-500 hover:text-green-500 hover:bg-green-50 rounded-l">+</button>
                    </div>
                </div>
            `;
        }

        function renderUploadZone(icon, label, subLabel, colorClass) {
            const [bg, border, text] = colorClass.split(' ');
            return `
                <div class="border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-colors hover:bg-opacity-70 ${colorClass}">
                    <div class="flex justify-center mb-3">
                        <div class="p-3 bg-white rounded-full shadow-sm">
                            <i data-lucide="${icon}" class="${text} w-6 h-6"></i>
                        </div>
                    </div>
                    <h4 class="font-semibold text-gray-700">${label}</h4>
                    <p class="text-xs text-gray-500 mt-1">${subLabel}</p>
                </div>
            `;
        }

        function getStatusLabel(status) {
            const opt = STATUS_OPTIONS.find(s => s.id === status);
            return opt ? opt.label : status;
        }

        function getStatusColor(status) {
            const opt = STATUS_OPTIONS.find(s => s.id === status);
            return opt ? opt.color : 'bg-gray-100 text-gray-800';
        }

        // --- Event Handlers & Logic ---

        function attachEventListeners() {
            // Re-bind inputs to state (simplistic approach for Vanilla JS)
            const nameInput = document.getElementById('input-name');
            if (nameInput) nameInput.addEventListener('input', e => newClientForm.name = e.target.value);
            
            const phoneInput = document.getElementById('input-phone');
            if (phoneInput) phoneInput.addEventListener('input', e => newClientForm.phone = e.target.value);

            const addressInput = document.getElementById('input-address');
            if (addressInput) addressInput.addEventListener('input', e => newClientForm.address = e.target.value);
        }

        function updateCounter(key, change) {
            const newVal = Math.max(0, newClientForm.projectDetails[key] + change);
            newClientForm.projectDetails[key] = newVal;
            // Update UI directly for speed
            const span = document.getElementById(`count-${key}`);
            if(span) span.innerText = newVal;
        }

        function handleSaveClient() {
            if (!newClientForm.name || !newClientForm.phone) {
                alert('الرجاء إدخال الاسم ورقم الجوال');
                return;
            }

            const client = {
                ...newClientForm,
                id: Date.now(),
                status: 'new',
                source: 'معرض', // default
                date: new Date().toLocaleDateString('en-US')
            };

            clients.unshift(client); // Add to top
            saveClients();
            
            // Reset Form
            newClientForm = {
                code: generateCode(),
                name: '', phone: '', address: '',
                projectDetails: { kitchen: 0, bedroom: 0, cladding: 0, doors: 0, vanity: 0, tvUnit: 0 }
            };
            
            alert('تم حفظ العميل بنجاح!');
        }

        function handleDeleteClient(id) {
            if (confirm('حذف هذا العميل؟')) {
                clients = clients.filter(c => c.id !== id);
                saveClients();
            }
        }

        // Start App
        init();
    </script>
</body>
</html>
